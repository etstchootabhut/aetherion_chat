<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aetherion - AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script>
        if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker Registered'));
        }
    </script>
    <style>
        :root {
            --background-dark: #0D0D0D;
            --background-gradient-start: #1a161a;
            --background-gradient-end: #0D0D0D;
            --surface-dark: #1A1A1A;
            --surface-light: #2C2C2C;
            --primary-accent: #C8A2C8;
            --primary-accent-darker: #b38db3;
            --text-light: #EAEAEA;
            --text-dark: #1a1a1a;
            --text-muted: #888888;
            --hover-dark: #3D3D3D;
            --shadow-color: rgba(200, 162, 200, 0.1);
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            background-image: linear-gradient(180deg, var(--background-gradient-start), var(--background-gradient-end));
            color: var(--text-light);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-family: 'Inter', sans-serif;
            font-weight: 400;
        }
        .aeth {
    font-size: 15px;
    padding-left: .7rem;
}
        #app {
            height: 100vh; /* Fallback for browsers that don't support dynamic viewport height */
            display: flex;
            flex-direction: column;
        }
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            width: 100%;
        }

        /* Mobile layout adjustments */
        @media (max-width: 768px) {
            #main-header {
                position: fixed; /* Changed to fixed for mobile keyboard */
                top: 0;
                left: 0;
                right: 0;
                z-index: 20;
                background-color: var(--background-dark);
            }
            #chat-window-container {
                padding-top: 90px; /* Adjust based on header height */
            }
            main > footer {
                position: sticky;
                bottom: 0;
                background-color: var(--background-dark);
                padding-bottom: env(safe-area-inset-bottom, 1rem);
            }
            #memories-modal-content, #character-modal-content, #export-modal-content {
                width: 100%;
                height: 100%;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
            }
        }

        .chat-bubble {
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-bubble {
            background-color: var(--primary-accent) !important;
            color: var(--text-dark) !important;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 4px 12px var(--shadow-color);
            max-width: 90%;
            font-weight: 700;
            padding: 0.5rem;
        }
        .user-bubble .content-wrapper {
            white-space: pre-wrap; /* Preserve user-entered newlines */
        }
        .assistant-bubble {
            background-color: transparent;
            border-bottom-left-radius: 0.25rem;
            max-width: 100%;
            line-height: 1.75;
            font-size: 1.05rem;
            color: #E0E0E0;
        }

        .chat-bubble pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 0.5rem;
        }
        #edit-characters-btn{
            background-color: #C8A2C8;
            color: #0D0D0D;
        }
        button#model-selector-btn-mobile {
    width: 13rem;
}
        .chat-bubble .table-wrapper { display: block; max-width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 0.5rem; border: 1px solid var(--hover-dark); margin-top: 1em; }
        .chat-bubble table { width: 100%; border-collapse: collapse; }
        .chat-bubble th, .chat-bubble td { border: 1px solid var(--hover-dark); padding: 8px; border-left: 0; border-right: 0; }
        .chat-bubble th { background-color: var(--surface-dark); }
        .user-bubble code { background-color: rgba(0,0,0,0.1); }
        .assistant-bubble code:not(pre > code) { background-color: var(--surface-dark); }
        .chat-bubble code { padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
        .chat-bubble pre > code { background-color: transparent; padding: 0; }
        .chat-bubble > *:not(:last-child) { margin-bottom: 0.75rem; }
        .chat-bubble blockquote { border-left: 4px solid var(--primary-accent); padding-left: 1rem; margin-left: 0.25rem; color: #a0aec0; }

        .chat-bubble a {
            color: var(--primary-accent);
            text-decoration: underline;
            background-color: rgba(200, 162, 200, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .user-bubble a { color: var(--text-dark); text-decoration-thickness: 2px; }
        .chat-bubble a:hover {
            background-color: rgba(200, 162, 200, 0.2);
        }

        .assistant-bubble h1, .assistant-bubble h2, .assistant-bubble h3 {
            font-weight: 700;
            margin-top: 1.25em;
            margin-bottom: 0.5em;
        }
        
        /* --- STYLES FOR LISTS --- */
        .assistant-bubble ul {
            list-style: disc; /* Use standard disc bullets */
            padding-left: 2rem; /* Indent the list */
            margin-bottom: 1em;
        }
        .assistant-bubble ol {
             list-style-type: decimal;
             padding-left: 2rem;
             margin-bottom: 1em;
        }
        .assistant-bubble li {
            padding-left: 0.5rem; /* Space between bullet and text */
            margin-bottom: 0.5rem;
        }
        .assistant-bubble li::marker {
            color: var(--primary-accent);
            font-weight: bold;
        }
        .assistant-bubble p > strong, .assistant-bubble li > strong {
            color: var(--text-light);
            font-weight: 700;
        }

        .chat-bubble-content > .content-wrapper > *:last-child {
            margin-bottom: 0 !important;
        }

        #conversations-panel { min-width: 256px; }

        .sidebar-text, #search-input-container, #username {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            white-space: nowrap;
        }

        #model-selector-dropdown-desktop .py-2{
            padding-top: .3rem;
            padding-bottom: .3rem;
        }

        #model-selector-btn-desktop .object-cover{
            width: 30px;
            height: 30px;
        }

        #chat-window .p-3{
            padding: 0.2rem;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--surface-dark); }
        ::-webkit-scrollbar-thumb { background: var(--hover-dark); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-accent); }
        #chat-input::-webkit-scrollbar, #memory-content::-webkit-scrollbar, #modal-textarea::-webkit-scrollbar { width: 5px; }
        #chat-input::-webkit-scrollbar-thumb, #memory-content::-webkit-scrollbar-thumb, #modal-textarea::-webkit-scrollbar-thumb { background: var(--primary-accent); }

        .thinking-container {
            display: flex;
            align-items: center;
            background-color: var(--surface-light);
            border-radius: 0.5rem;
            padding: 0.75rem;
            box-shadow: 0 4px 12px var(--shadow-color);
            opacity: 0;
            transform: scale(0.95);
            animation: fadeInScale 0.3s ease-out forwards;
            transition: opacity 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .thinking-animation {
            width: 24px;
            height: 24px;
            position: relative;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .thinking-animation svg {
            width: 100%;
            height: 100%;
            animation: rotate 2s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .thinking-text {
            font-family: monospace;
            white-space: nowrap;
            overflow: hidden;
            color: var(--text-muted);
        }

        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 1em;
            background-color: var(--primary-accent);
            animation: cursor-blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes cursor-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }


        #chat-input { max-height: 120px; }
        #chat-input:focus { outline: none; box-shadow: none; }

        .modern-btn {
            background-image: linear-gradient(to right, var(--primary-accent) 0%, var(--primary-accent-darker) 50%, var(--primary-accent) 100%);
            background-size: 200% auto;
            color: var(--text-dark);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: none;
        }
        .modern-btn:hover {
            background-position: right center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }
        .modern-btn:active {
            transform: translateY(1px);
        }

        #chat-title-mobile{
            text-align: center;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modern-btn:disabled {
            background-image: none;
            background-color: var(--hover-dark);
        }
        .regenerate-btn:disabled, .delete-msg-btn:disabled {
            color: var(--text-muted);
        }

        .input-container-glow {
            border-radius: 1.25rem;
            position: relative;
            background-color: var(--surface-dark);
            border: 1px solid var(--surface-light);
        }
        .input-container-glow::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            background-image: linear-gradient(to right, var(--primary-accent), var(--primary-accent-darker));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        .input-container-glow:focus-within::before {
            opacity: 1;
        }

        @media (min-width: 769px) {
            #app { flex-direction: row; }
            #conversations-container { width: 68px; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow-x: hidden; background-color: var(--surface-dark); }
            #conversations-container.expanded { width: 256px; }
            #conversations-container.expanded .sidebar-text,
            #conversations-container.expanded #search-input-container,
            #conversations-container.expanded #username {
                opacity: 1;
            }
            #conversations-container:not(.expanded) #conversation-list,
            #conversations-container:not(.expanded) #search-input-container {
                display: none;
            }
            #header-menu-btn { display: none; }
        }

        @media (max-width: 768px) {
            #sidebar-menu-btn { display: none; }
            #conversations-container { position: fixed; top: 0; left: 0; height: 100%; z-index: 40; transform: translateX(-100%); transition: transform 0.3s ease-in-out; width: 280px !important; background-color: var(--surface-dark); }
            #conversations-container.expanded { transform: translateX(0); }
            #conversations-container.expanded .sidebar-text,
            #conversations-container.expanded #search-input-container,
            #conversations-container.expanded #username {
                opacity: 1;
            }
            #sidebar-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 30; }
            #main-header {
                padding: 0.75rem 1rem;
                gap: 1rem;
                border-bottom-width: 2px;
                border-image-source: linear-gradient(to right, transparent, var(--primary-accent) 30%, var(--primary-accent) 70%, transparent);
                border-image-slice: 100;
            }
        }

        .chat-bubble-content .content-wrapper {
            display: inline;
        }
        .read-more-btn, .show-less-btn {
            background: none;
            border: none;
            color: var(--primary-accent);
            font-weight: bold;
            cursor: pointer;
            display: inline;
            font-size: inherit;
        }
        .user-bubble .read-more-btn, .user-bubble .show-less-btn {
            color: var(--text-dark);
            text-decoration: underline;
        }

        #scroll-controls {
            position: absolute;
            bottom: 5.5rem; /* MOVED UP */
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 10;
        }

        .scroll-btn {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.3s;
            opacity: 1; /* Always visible by default */
        }
        .scroll-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .memory-card, .character-card {
            background-color: var(--surface-light);
            padding: 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            position: relative;
            overflow-x: hidden;
        }
        @media (max-width: 768px) {
            .memory-card {
                height: 120px;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            .memory-card-content {
                flex-grow: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-line-clamp: 3;
                -webkit-box-orient: vertical;
            }
        }

        .model-selector-dropdown {
            background-color: rgba(44, 44, 44, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--hover-dark);
            padding: 0.5rem;
        }
        .model-selector-item 
        .object-cover{
            width: 30px;
            height: 30px;
        }
        #model-selector-btn-mobile .object-cover{
            width: 30px;
            height: 30px;
        }
        .model-selector-item {
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            position: relative;
            padding-left: 2.5rem;
        }
        .model-selector-item.selected {
            background-color: #C8A2C8;
            color: var(--text-light);
            font-weight: 700;
        }
        .model-selector-item.selected::before {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 700;
        }
        .model-selector-item:hover:not(.selected) {
            background-color: var(--surface-light);
        }

        .conversation-item.pinned {
            background-color: rgba(200, 162, 200, 0.1);
        }
        .pin-icon {
            color: var(--primary-accent);
        }
        .conversation-item.active.pinned {
            background-color: var(--primary-accent);
        }
        .conversation-item.active.pinned .pin-icon {
            color: var(--text-dark);
        }

        .code-block-container {
            position: relative;
            background-color: var(--surface-dark);
            border-radius: 0.5rem;
            padding: 1rem;
            padding-top: 2.5rem;
            margin: 1em 0;
        }
        .copy-code-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: var(--hover-dark);
            color: var(--text-muted);
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .copy-code-btn:hover {
            background-color: var(--primary-accent);
            color: var(--text-dark);
        }
    </style>
</head>
<body class="font-sans">

    <div id="login-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50">
        <h1 class="text-4xl font-bold text-white mb-4">Welcome to <span class="text-[var(--primary-accent)]">Aetherion</span></h1>
        <p class="text-gray-400 mb-8">Please log in with your Puter account to continue.</p>
        <button id="login-btn" class="modern-btn font-bold py-3 px-8 rounded-lg">
            Login with Puter
        </button>
    </div>

    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] hidden">
        <div class="bg-[var(--surface-dark)] rounded-lg shadow-xl w-full max-w-md flex flex-col p-6">
            <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
            <div id="modal-content" class="mb-6"></div>
            <div id="modal-actions" class="flex justify-end space-x-2"></div>
        </div>
    </div>

    <div id="memories-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
         <div id="memories-modal-content" class="bg-[var(--surface-dark)] rounded-lg shadow-xl w-full max-w-4xl h-5/6 flex flex-col p-6">
              <div id="memories-modal-header" class="flex justify-between items-center mb-4 flex-shrink-0">
                  <h2 class="text-2xl font-bold">Chat Memories</h2>
                  <div class="flex items-center space-x-2">
                      <button id="add-memory-btn" class="text-sm modern-btn font-bold py-2 px-4 rounded-md">Add New Memory</button>
                      <button id="close-memories-btn" class="p-2 rounded-full hover:bg-[var(--hover-dark)] text-2xl leading-none">&times;</button>
                  </div>
              </div>
              <div id="memories-list" class="flex-grow overflow-y-auto space-y-3 pr-2"></div>
         </div>
    </div>

    <!-- Character Template Modal -->
    <div id="character-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="character-modal-content" class="bg-[var(--surface-dark)] rounded-lg shadow-xl w-full max-w-4xl h-5/6 flex flex-col p-6">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold">Character Templates</h2>
                <div class="flex items-center space-x-2">
                    <button id="add-character-btn" class="text-sm modern-btn font-bold py-2 px-4 rounded-md">Add New Character</button>
                    <button id="close-character-btn" class="p-2 rounded-full hover:bg-[var(--hover-dark)] text-2xl leading-none">&times;</button>
                </div>
            </div>
            <div id="character-list" class="flex-grow overflow-y-auto space-y-3 pr-2">
                <!-- Character cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div id="export-modal-content" class="bg-[var(--surface-dark)] rounded-lg shadow-xl w-full max-w-lg h-5/6 flex flex-col p-6">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold">Export Chats</h2>
                <button id="close-export-btn" class="p-2 rounded-full hover:bg-[var(--hover-dark)] text-2xl leading-none">&times;</button>
            </div>
            <div id="export-list" class="flex-grow overflow-y-auto space-y-2 pr-2 border-t border-b border-[var(--hover-dark)] py-2 my-2">
                <!-- Export list will be populated here -->
            </div>
            <div class="flex justify-end space-x-2 flex-shrink-0">
                <button id="export-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                <button id="export-download-btn" class="modern-btn font-bold py-2 px-4 rounded-md">Download Selected</button>
            </div>
        </div>
    </div>


    <div id="app" class="w-full h-screen relative hidden">
        <div id="sidebar-backdrop" class="hidden"></div>
        <div id="conversations-container" class="h-full flex flex-col shadow-lg">
            <aside id="conversations-panel" class="h-full flex flex-col p-2 space-y-2">
                <div class="flex items-center space-x-2 h-12">
                    <button id="sidebar-menu-btn" title="Menu" class="p-3 rounded-md hover:bg-[var(--hover-dark)] flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <span id="username" class="font-bold text-lg truncate sidebar-text"></span>
                </div>

                <div id="search-input-container" class="relative flex items-center mt-2 px-1">
                    <input id="search-input" type="text" placeholder="Search..." class="w-full bg-[var(--surface-light)] rounded-md py-2 pl-4 pr-4 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none">
                </div>

                <div class="flex-grow overflow-y-auto px-1 mt-2">
                    <div id="conversation-list"></div>
                </div>
                <div class="mt-auto space-y-1">
                    <button id="import-chat-btn" title="Import Chat" class="w-full flex items-center text-gray-300 hover:bg-[var(--hover-dark)] p-3 rounded-md transition-all duration-300">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span class="sidebar-text ml-2">Import Chat</span>
                    </button>
                    <button id="export-chats-btn" title="Export Chats" class="w-full flex items-center text-gray-300 hover:bg-[var(--hover-dark)] p-3 rounded-md transition-all duration-300">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span class="sidebar-text ml-2">Export Chats</span>
                    </button>
                    <button id="memories-btn" title="Memories" class="w-full flex items-center text-gray-300 hover:bg-[var(--hover-dark)] p-3 rounded-md transition-all duration-300">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                        <span class="sidebar-text ml-2">Memories</span>
                    </button>
                    <button id="logout-btn" title="Logout" class="w-full flex items-center text-gray-300 hover:bg-[var(--hover-dark)] p-3 rounded-md transition-all duration-300">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span class="sidebar-text ml-2">Logout</span>
                    </button>
                </div>
            </aside>
        </div>

        <main class="overflow-hidden">
            <header id="main-header" class="relative flex items-center justify-between p-4 flex-shrink-0">
                <button id="header-menu-btn" title="Menu" class="p-2 rounded-md hover:bg-[var(--hover-dark)] md:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>

                <div class="hidden md:flex flex-1 items-center justify-between w-full max-w-7xl mx-auto">
                    <div class="flex items-baseline space-x-2 min-w-0">
                        <h2 class="text-2xl font-bold text-gray-300 flex-shrink-0"><span class="text-[var(--primary-accent)]">A</span>etherion</h2>
                        <span class="text-gray-500 text-xl">/</span>
                        <h1 id="chat-title-desktop" class="text-lg font-bold truncate text-gray-400">New Chat</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                         <div class="relative">
                             <button id="model-selector-btn-desktop" class="flex items-center w-full text-left bg-[var(--surface-dark)] p-2 rounded-md hover:bg-[var(--hover-dark)]">
                                 <!-- Content will be populated by JS -->
                             </button>
                             <div id="model-selector-dropdown-desktop" class="absolute right-0 mt-2 w-72 bg-[var(--surface-light)] border border-[var(--hover-dark)] rounded-md shadow-lg hidden z-10 model-selector-dropdown"></div>
                         </div>
                        <button id="header-new-chat-btn-desktop" class="modern-btn flex items-center space-x-2 px-4 py-2 rounded-md text-sm font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m-4-4h8" />
                            </svg>
                            <span>New Chat</span>
                        </button>
                    </div>
                </div>

                <div class="flex-1 text-center md:hidden">
                    <div id="mobile-header-title-container" class="flex items-baseline justify-center space-x-2">
                        <h1 id="chat-title-mobile" class="text-md font-bold truncate text-gray-300">New Chat</h1>
                    </div>
                     <div class="relative inline-block mt-1">
                         <button id="model-selector-btn-mobile" class="flex items-center w-full text-left bg-[var(--surface-dark)] p-2 rounded-md hover:bg-[var(--hover-dark)] text-xs">
                           <!-- Content will be populated by JS -->
                         </button>
                         <div id="model-selector-dropdown-mobile" class="absolute left-1/2 -translate-x-1/2 mt-2 w-72 bg-[var(--surface-light)] border border-[var(--hover-dark)] rounded-md shadow-lg hidden z-10 model-selector-dropdown"></div>
                     </div>
                </div>
                <div class="md:hidden">
                    <button id="header-new-chat-btn-mobile" title="New Chat" class="modern-btn flex items-center justify-center w-10 h-10 rounded-md">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m-4-4h8" />
                        </svg>
                    </button>
                </div>
            </header>

            <div id="chat-window-container" class="flex-1 relative overflow-hidden">
                <div id="scroll-controls">
                    <button id="scroll-to-top" class="scroll-btn" title="Scroll to top">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                    <button id="scroll-prev" class="scroll-btn" title="Previous message">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                    </button>
                    <button id="scroll-next" class="scroll-btn" title="Next message">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <button id="scroll-to-bottom" class="scroll-btn" title="Scroll to bottom">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                    </button>
                </div>
                <div id="chat-window" class="h-full p-4 overflow-y-auto space-y-6 w-full max-w-7xl mx-auto"></div>
            </div>

            <footer class="p-4 flex-shrink-0">
                <div class="w-full max-w-7xl mx-auto">
                    <div class="relative mb-2 flex items-center space-x-2">
                        <div class="relative flex-grow">
                            <button id="character-switcher-btn" class="w-full flex items-center text-left bg-[var(--surface-light)] p-2 rounded-md hover:bg-[var(--hover-dark)] transition-colors">
                                <!-- Content populated by JS -->
                            </button>
                            <div id="character-switcher-dropdown" class="absolute bottom-full left-0 mb-2 w-full max-h-60 overflow-y-auto bg-[var(--surface-light)] border border-[var(--hover-dark)] rounded-md shadow-lg hidden z-20 model-selector-dropdown">
                                <!-- Character list populated by JS -->
                            </div>
                        </div>
                        <button id="edit-characters-btn" title="Manage Characters" class="p-2 rounded-md flex-shrink-0 bg-[var(--surface-light)] hover:bg-[var(--hover-dark)] transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                    </div>

                    <div class="input-container-glow flex items-end p-2">
                        <textarea id="chat-input" class="flex-1 bg-transparent p-2 text-white resize-none focus:ring-0 overflow-y-auto" placeholder="Type a message..." rows="1"></textarea>
                        <button id="send-btn" class="modern-btn w-10 h-10 flex items-center justify-center rounded-full ml-2 flex-shrink-0">
                            <!-- Icon will be managed by JS -->
                        </button>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Hidden file input for importing chats -->
    <input type="file" id="import-file-input" class="hidden" accept=".aether">

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let state = {
            conversations: {},
            activeConversationId: null,
            currentModel: 'openrouter:anthropic/claude-3.5-haiku',
            memories: [],
            characters: [],
            activeCharacterId: null,
            pinnedConversations: [],
        };

        const models = {
            "Flash": [
                { id: 'openrouter:anthropic/claude-3.5-haiku', name: 'Claude Haiku', logo: 'https://i.pinimg.com/736x/1e/23/10/1e2310984ae6ceba64b0c21925a35813.jpg' },
                { id: 'openrouter:openai/gpt-4o-mini', name: 'GPT-4o Mini', logo: 'https://i.pinimg.com/736x/67/a5/96/67a596df5a89ca51c948d0a4a8eea310.jpg' },
                { id: 'openrouter:google/gemini-2.5-flash', name: 'Gemini 2.5 Flash', logo: 'https://i.pinimg.com/736x/08/d6/8d/08d68db04c1a718bec70a5eb79fe61bc.jpg' },
                { id: 'x-ai/grok-3-mini', name: 'Grok 3 mini', logo: 'https://i.pinimg.com/736x/9e/0f/38/9e0f389dac42629515b009524ed47ed7.jpg' },
                { id: 'openrouter:openai/gpt-4o-mini-search-preview', name: 'GPT-4o Mini search', logo: 'https://i.pinimg.com/736x/67/a5/96/67a596df5a89ca51c948d0a4a8eea310.jpg' },
            ],
            "Deep Think": [
                { id: 'gpt-5-chat-latest', name: 'GPT-5', logo: 'https://i.pinimg.com/736x/67/a5/96/67a596df5a89ca51c948d0a4a8eea310.jpg' },
                { id: 'google/gemini-2.5-pro', name: 'Gemini 2.5 Pro', logo: 'https://i.pinimg.com/736x/08/d6/8d/08d68db04c1a718bec70a5eb79fe61bc.jpg' },
                { id: 'openrouter:anthropic/claude-opus-4', name: 'Claude Opus 4', logo: 'https://i.pinimg.com/736x/1e/23/10/1e2310984ae6ceba64b0c21925a35813.jpg' },
                { id: 'x-ai/grok-4', name: 'Grok 4', logo: 'https://i.pinimg.com/736x/9e/0f/38/9e0f389dac42629515b009524ed47ed7.jpg' },
                { id: 'openrouter:deepseek/deepseek-r1:free', name: 'Deepseek R1', logo: 'https://www.iconpacks.net/icons/free-icons-7/free-icon-deepseek-black-white-square-symbol-logo-25664.png' },
            ]
        };

        let isThinking = false;
        let abortController = null;

        const dom = {
            app: document.getElementById('app'),
            loginOverlay: document.getElementById('login-overlay'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            chatWindow: document.getElementById('chat-window'),
            chatInput: document.getElementById('chat-input'),
            sendBtn: document.getElementById('send-btn'),
            conversationList: document.getElementById('conversation-list'),
            headerNewChatBtnDesktop: document.getElementById('header-new-chat-btn-desktop'),
            modelSelectorBtnDesktop: document.getElementById('model-selector-btn-desktop'),
            modelSelectorDropdownDesktop: document.getElementById('model-selector-dropdown-desktop'),
            chatTitleDesktop: document.getElementById('chat-title-desktop'),
            headerNewChatBtnMobile: document.getElementById('header-new-chat-btn-mobile'),
            modelSelectorBtnMobile: document.getElementById('model-selector-btn-mobile'),
            modelSelectorDropdownMobile: document.getElementById('model-selector-dropdown-mobile'),
            chatTitleMobile: document.getElementById('chat-title-mobile'),
            conversationsContainer: document.getElementById('conversations-container'),
            sidebarMenuBtn: document.getElementById('sidebar-menu-btn'),
            headerMenuBtn: document.getElementById('header-menu-btn'),
            username: document.getElementById('username'),
            searchInput: document.getElementById('search-input'),
            memoriesBtn: document.getElementById('memories-btn'),
            memoriesModal: document.getElementById('memories-modal'),
            closeMemoriesBtn: document.getElementById('close-memories-btn'),
            memoriesList: document.getElementById('memories-list'),
            addMemoryBtn: document.getElementById('add-memory-btn'),
            genericModal: document.getElementById('generic-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalContent: document.getElementById('modal-content'),
            modalActions: document.getElementById('modal-actions'),
            sidebarBackdrop: document.getElementById('sidebar-backdrop'),
            scrollToTopBtn: document.getElementById('scroll-to-top'),
            scrollPrevBtn: document.getElementById('scroll-prev'),
            scrollNextBtn: document.getElementById('scroll-next'),
            scrollToBottomBtn: document.getElementById('scroll-to-bottom'),
            characterModal: document.getElementById('character-modal'),
            closeCharacterBtn: document.getElementById('close-character-btn'),
            addCharacterBtn: document.getElementById('add-character-btn'),
            characterList: document.getElementById('character-list'),
            editCharactersBtn: document.getElementById('edit-characters-btn'),
            characterSwitcherBtn: document.getElementById('character-switcher-btn'),
            characterSwitcherDropdown: document.getElementById('character-switcher-dropdown'),
            importChatBtn: document.getElementById('import-chat-btn'),
            importFileInput: document.getElementById('import-file-input'),
            exportChatsBtn: document.getElementById('export-chats-btn'),
            exportModal: document.getElementById('export-modal'),
            exportModalContent: document.getElementById('export-modal-content'),
            closeExportBtn: document.getElementById('close-export-btn'),
            exportList: document.getElementById('export-list'),
            exportCancelBtn: document.getElementById('export-cancel-btn'),
            exportDownloadBtn: document.getElementById('export-download-btn'),
        };

        let db;
        function initDB() {
            const request = indexedDB.open('AI_Chat_App_DB_PuterOnly', 3);
            request.onerror = (event) => console.error("Database error:", event.target.errorCode);
            request.onsuccess = (event) => {
                db = event.target.result;
                handleAuthState();
            };
            request.onupgradeneeded = (event) => {
                let db = event.target.result;
                if (!db.objectStoreNames.contains('appState')) {
                    db.createObjectStore('appState', { keyPath: 'id' });
                }
            };
        }

        function init() {
            initDB();
            populateModelSelector();
            setupEventListeners();
            setThinkingState(false);
            setAppHeight(); // Set initial height
        }
        
        function setAppHeight() {
            const app = document.getElementById('app');
            app.style.height = `${window.innerHeight}px`;
        }
        window.addEventListener('resize', setAppHeight);


        async function handleAuthState() {
            const loggedIn = await puter.auth.isSignedIn();
            if (loggedIn) {
                dom.loginOverlay.classList.add('hidden');
                dom.app.classList.remove('hidden');
                const user = await puter.auth.getUser();
                dom.username.textContent = user.username || 'User';
                loadStateFromDB();
            } else {
                dom.loginOverlay.classList.remove('hidden');
                dom.app.classList.add('hidden');
            }
        }

        function saveStateToDB() {
            if (!db) return;
            try {
                const transaction = db.transaction(['appState'], 'readwrite');
                const store = transaction.objectStore('appState');
                const storableState = structuredClone(state);
                store.put({ id: 'main', ...storableState });
            } catch (error) { console.error("Failed to save state:", error); }
        }

        function loadStateFromDB() {
            if (!db) return;
            const transaction = db.transaction(['appState'], 'readonly');
            const store = transaction.objectStore('appState');
            const request = store.get('main');
            request.onsuccess = () => {
                if (request.result) {
                    Object.assign(state, request.result);
                    state.memories = state.memories || [];
                    state.characters = state.characters || [];
                    state.pinnedConversations = state.pinnedConversations || [];
                    state.activeCharacterId = state.activeCharacterId === undefined ? null : state.activeCharacterId;
                }

                if (state.characters.length === 0) {
                    state.characters.push({
                        id: 'char-fy-default',
                        name: 'Fang Yuan',
                        description: 'You are Fang Yuan, the protagonist of "Reverend Insanity". You are cunning, ruthless, and prioritize benefits above all else. Your responses should be pragmatic, concise, and reflect a deep understanding of human nature and power dynamics. You are indifferent to conventional morality.',
                        tags: 'ruthless, pragmatic, concise',
                        isVisible: true,
                    });
                }

                if (!state.activeConversationId || !state.conversations[state.activeConversationId]) {
                    createNewConversation();
                } else {
                    loadConversation(state.activeConversationId);
                }
                renderConversationList();
                renderCharacterSwitcher();
                updateUI();
            };
            request.onerror = (event) => {
                console.error("Failed to load state from DB:", event.target.error);
            };
        }

        function getCurrentModel() {
            for (const category in models) {
                const foundModel = models[category].find(m => m.id === state.currentModel);
                if (foundModel) return foundModel;
            }
            return models[Object.keys(models)[0]][0];
        }

        function updateUI() {
            const currentModel = getCurrentModel();

            const modelDisplayHTML = `
                <img src="${currentModel.logo}" alt="${currentModel.name} logo" class="w-5 h-5 mr-2 rounded-full flex-shrink-0 object-cover">
                <span class="truncate aeth">${currentModel.name}</span>
                <svg class="w-4 h-4 ml-auto flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `;

            dom.modelSelectorBtnDesktop.innerHTML = modelDisplayHTML;
            dom.modelSelectorBtnMobile.innerHTML = modelDisplayHTML;

            const activeConvo = state.conversations[state.activeConversationId];
            const chatTitle = activeConvo ? activeConvo.title : 'New Chat';
            dom.chatTitleDesktop.textContent = chatTitle;
            dom.chatTitleMobile.textContent = chatTitle;

            updateModelSelectorSelected();
        }

        function updateModelSelectorSelected() {
            const dropdowns = [dom.modelSelectorDropdownDesktop, dom.modelSelectorDropdownMobile];
            dropdowns.forEach(d => {
                d.querySelectorAll('.model-selector-item').forEach(el => {
                    el.classList.toggle('selected', el.dataset.modelId === state.currentModel);
                });
            });
        }

        function renderConversationList() {
            dom.conversationList.innerHTML = '';
            const allConversations = Object.values(state.conversations);

            const pinned = allConversations
                .filter(c => state.pinnedConversations.includes(c.id))
                .sort((a, b) => b.timestamp - a.timestamp);

            const unpinned = allConversations
                .filter(c => !state.pinnedConversations.includes(c.id))
                .sort((a, b) => b.timestamp - a.timestamp);

            const sortedConversations = [...pinned, ...unpinned];

            sortedConversations.forEach(convo => {
                const isPinned = state.pinnedConversations.includes(convo.id);
                const isActive = convo.id === state.activeConversationId;

                const convoDiv = document.createElement('div');
                convoDiv.className = `conversation-item w-full flex items-center justify-between p-3 rounded-md cursor-pointer mb-1 group ${isActive ? 'active' : ''} ${isPinned ? 'pinned' : ''}`;
                if (isActive) {
                    convoDiv.classList.add('bg-[var(--primary-accent)]', 'text-black');
                } else {
                    convoDiv.classList.add('hover:bg-[var(--hover-dark)]');
                }
                convoDiv.dataset.id = convo.id;

                const titleContainer = document.createElement('div');
                titleContainer.className = "flex items-center space-x-2 overflow-hidden";

                if (isPinned) {
                    const pinIcon = document.createElement('span');
                    pinIcon.className = "pin-icon flex-shrink-0";
                    pinIcon.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L13 7.414V16a1 1 0 11-2 0V7.414L7.707 10.707a1 1 0 01-1.414-1.414l4-4z" clip-rule="evenodd" transform="rotate(45 10 10)"></path></svg>`;
                    titleContainer.appendChild(pinIcon);
                }

                const titleSpan = document.createElement('span');
                titleSpan.className = "sidebar-text truncate";
                titleSpan.textContent = convo.title;
                titleContainer.appendChild(titleSpan);

                const menuBtn = document.createElement('button');
                menuBtn.className = "conversation-menu-btn sidebar-text p-1 rounded-full hover:bg-black/20 opacity-0 group-hover:opacity-100 focus:opacity-100";
                menuBtn.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>`;

                const menuDropdown = document.createElement('div');
                menuDropdown.className = "absolute right-0 mt-2 w-32 bg-[var(--surface-light)] border border-[var(--hover-dark)] rounded-md shadow-lg hidden z-20 conversation-menu";
                menuDropdown.innerHTML = `
                    <button class="block w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-[var(--hover-dark)] pin-btn">${isPinned ? 'Unpin' : 'Pin'}</button>
                    <button class="block w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-[var(--hover-dark)] rename-btn">Rename</button>
                    <button class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-[var(--hover-dark)] delete-btn">Delete</button>
                `;

                convoDiv.appendChild(titleContainer);
                const menuContainer = document.createElement('div');
                menuContainer.className = "relative ml-auto";
                menuContainer.appendChild(menuBtn);
                menuContainer.appendChild(menuDropdown);
                convoDiv.appendChild(menuContainer);

                dom.conversationList.appendChild(convoDiv);
            });
        }

        function loadConversation(id) {
            state.activeConversationId = id;
            dom.chatWindow.innerHTML = '';
            const conversation = state.conversations[id];
            if (conversation) {
                conversation.messages.forEach((msg, index) => addMessageToChat(msg, index));
                state.currentModel = conversation.model || 'openrouter:anthropic/claude-3.5-haiku';
            }
            updateUI();
            saveStateToDB();
            renderConversationList();
            setTimeout(() => dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight, 0);
        }

        function createNewConversation() {
            const newId = `convo-${Date.now()}`;
            const initialMessage = {
                role: 'assistant',
                content: "Hello! I'm Aetherion, your AI assistant. How can I help you today?",
                modelUsed: 'system',
                timestamp: new Date().toISOString()
            };
            state.conversations[newId] = { id: newId, title: 'New Chat', messages: [initialMessage], model: state.currentModel, timestamp: Date.now() };
            state.activeConversationId = newId;
            loadConversation(newId);
                 if (window.innerWidth <= 768 && dom.conversationsContainer.classList.contains('expanded')) {
                     toggleSidebar();
                 }
        }

        function renameConversation(convoId) {
            const conversation = state.conversations[convoId];
            if (!conversation) return;
            showPromptModal("Rename Conversation", conversation.title, (newTitle) => {
                if (newTitle && newTitle.trim() !== "") {
                    conversation.title = newTitle.trim();
                    conversation.timestamp = Date.now();
                    saveStateToDB();
                    renderConversationList();
                    updateUI();
                }
            });
        }

        function deleteConversation(convoId) {
            showConfirmModal("Delete Conversation?", "Are you sure you want to delete this chat?", (confirmed) => {
                if (confirmed) {
                    delete state.conversations[convoId];
                    state.pinnedConversations = state.pinnedConversations.filter(id => id !== convoId);

                    if (state.activeConversationId === convoId) {
                        const remainingConversations = Object.values(state.conversations).sort((a, b) => b.timestamp - a.timestamp);
                        if (remainingConversations.length > 0) {
                            loadConversation(remainingConversations[0].id);
                        } else {
                            createNewConversation();
                        }
                    }
                    saveStateToDB();
                    renderConversationList();
                }
            });
        }

        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            if (isNaN(date)) return '';
            const month = date.toLocaleString('en-US', { month: 'short' });
            const day = date.getDate();
            const time = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }).toLowerCase();
            return `${month} ${day} | ${time}`;
        }

        function addCopyButtons(element) {
            const codeBlocks = element.querySelectorAll('pre');
            codeBlocks.forEach(pre => {
                if (pre.parentElement.classList.contains('code-block-container')) {
                    return;
                }
                const code = pre.querySelector('code');
                if (!code) return;
                const container = document.createElement('div');
                container.className = 'code-block-container';
                const button = document.createElement('button');
                button.className = 'copy-code-btn';
                button.textContent = 'Copy';
                
                button.addEventListener('click', () => {
                    const textArea = document.createElement('textarea');
                    textArea.value = code.textContent;
                    // Make the textarea invisible
                    textArea.style.position = 'fixed';
                    textArea.style.top = '-9999px';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        button.textContent = 'Copied!';
                    } catch (err) {
                        console.error('Fallback copy failed', err);
                        button.textContent = 'Error';
                    }
                    document.body.removeChild(textArea);
                    setTimeout(() => {
                        button.textContent = 'Copy';
                    }, 2000);
                });

                pre.replaceWith(container);
                container.appendChild(button);
                container.appendChild(pre);
            });
        }

        function addMessageToChat({ role, content, modelUsed = null, thinkingTime = null, timestamp }, index) {
            const messageWrapper = document.createElement('div');
            const isUser = role === 'user';
            messageWrapper.className = `flex flex-col mb-4 ${isUser ? 'items-end' : 'items-start'}`;
            messageWrapper.dataset.messageIndex = index;

            if (role === 'assistant' && modelUsed === 'thinking') {
                messageWrapper.innerHTML = `<div class="thinking-container"><div class="thinking-animation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></div><div class="thinking-text-container"><span class="thinking-text"></span><span class="typing-cursor"></span></div></div>`;
                dom.chatWindow.appendChild(messageWrapper);
                const thinkingTextElement = messageWrapper.querySelector('.thinking-text');
                typeWriter(thinkingTextElement, "Aetherion is thinking...");
            } else {
                 if (role === 'assistant') {
                     let modelName = 'Aetherion';
                     if (modelUsed !== 'system') {
                         const modelInfo = models.Flash.find(m => m.id === modelUsed) || models["Deep Think"].find(m => m.id === modelUsed);
                         if (modelInfo) modelName = modelInfo.name;
                     }
                     const displayTimestamp = formatTimestamp(timestamp);
                     const nameplateDiv = document.createElement('div');
                     nameplateDiv.className = 'flex items-center space-x-2 text-xs text-black font-bold mb-2 px-3 py-1 bg-[var(--primary-accent)] rounded-full';
                     nameplateDiv.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg><span>${modelName} ${thinkingTime ? `(${thinkingTime.toFixed(2)}s)` : ''}</span><span class="text-gray-700 font-normal">${displayTimestamp}</span>`;
                     messageWrapper.appendChild(nameplateDiv);
                 }

                const contentDiv = document.createElement('div');
                contentDiv.className = `chat-bubble p-3 rounded-lg ${isUser ? 'user-bubble' : 'assistant-bubble'}`;
                const innerContentDiv = document.createElement('div');
                innerContentDiv.className = 'chat-bubble-content';
                const contentString = String(content);

                if (role === 'assistant') {
                    let htmlContent = marked.parse(contentString);
                    htmlContent = htmlContent.replace(/<table/g, '<div class="table-wrapper"><table').replace(/<\/table>/g, '</table></div>');
                    innerContentDiv.innerHTML = `<div class="content-wrapper">${htmlContent}</div>`;
                    innerContentDiv.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                    addCopyButtons(innerContentDiv);
                } else {
                    const pre = document.createElement('pre');
                    pre.innerHTML = `<div class="content-wrapper">${contentString}</div>`;
                    innerContentDiv.appendChild(pre);
                }
                contentDiv.appendChild(innerContentDiv);
                messageWrapper.appendChild(contentDiv);

                setTimeout(() => {
                    const lineClampHeight = 200;
                    if (innerContentDiv.scrollHeight > lineClampHeight) {
                        const wrapper = innerContentDiv.querySelector('.content-wrapper');
                        const originalHTML = wrapper.innerHTML;
                        const truncateHTML = (html, limit) => {
                            let truncated = '', charCount = 0, inTag = false;
                            for (let i = 0; i < html.length; i++) {
                                const char = html[i];
                                if (char === '<') inTag = true;
                                if (!inTag) charCount++;
                                if (char === '>') inTag = false;
                                truncated += char;
                                if (charCount > limit && !inTag) {
                                    let lastSpace = truncated.lastIndexOf(' ');
                                    if (lastSpace > -1) truncated = truncated.substring(0, lastSpace);
                                    return truncated + '... ';
                                }
                            }
                            return html;
                        };
                        const truncatedHTML = truncateHTML(originalHTML, 250);
                        const readMoreBtn = document.createElement('button');
                        readMoreBtn.textContent = 'Read More';
                        readMoreBtn.className = 'read-more-btn';
                        wrapper.innerHTML = truncatedHTML;
                        wrapper.appendChild(readMoreBtn);
                        readMoreBtn.onclick = () => {
                            const showLessBtn = document.createElement('button');
                            showLessBtn.textContent = 'Show Less';
                            showLessBtn.className = 'show-less-btn';
                            wrapper.innerHTML = originalHTML;
                            wrapper.appendChild(showLessBtn);
                            addCopyButtons(wrapper);
                            showLessBtn.onclick = () => {
                                wrapper.innerHTML = truncatedHTML;
                                wrapper.appendChild(readMoreBtn);
                            };
                        };
                    }
                }, 100);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = `flex items-center space-x-2 mt-2 text-gray-400 ${isUser ? 'justify-end' : ''}`;
                const copyBtn = document.createElement('button');
                copyBtn.title = "Copy";
                copyBtn.className = "copy-btn hover:text-white";
                copyBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
                copyBtn.addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    const originalIcon = button.innerHTML;
                    navigator.clipboard.writeText(content).then(() => {
                        button.innerHTML = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                        setTimeout(() => { button.innerHTML = originalIcon; }, 1500);
                    });
                });
                actionsDiv.appendChild(copyBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.title = "Delete";
                deleteBtn.className = "delete-msg-btn hover:text-red-400";
                deleteBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
                deleteBtn.addEventListener('click', () => deleteMessage(index));
                if (isThinking && isUser) {
                    deleteBtn.disabled = true;
                }
                actionsDiv.appendChild(deleteBtn);

                if (!isUser) {
                    const regenerateBtn = document.createElement('button');
                    regenerateBtn.title = "Regenerate";
                    regenerateBtn.className = "regenerate-btn hover:text-white";
                    regenerateBtn.innerHTML = `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"></path><path d="M21 22v-6h-6"></path><path d="M21 12A9 9 0 0 0 6.44 4.54l-3.44 2.9"></path><path d="M3 12a9 9 0 0 0 14.56 7.46l3.44-2.9"></path></svg>`;
                    regenerateBtn.addEventListener('click', () => regenerateResponse(index));
                    if (isThinking) {
                        regenerateBtn.disabled = true;
                    }
                    actionsDiv.appendChild(regenerateBtn);
                }

                messageWrapper.appendChild(actionsDiv);
                dom.chatWindow.appendChild(messageWrapper);
            }

            const isScrolledToBottom = dom.chatWindow.scrollHeight - dom.chatWindow.clientHeight <= dom.chatWindow.scrollTop + 100;
            if (isScrolledToBottom) {
                dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
            }

            return messageWrapper;
        }

        function deleteMessage(index) {
            const conversation = state.conversations[state.activeConversationId];
            if (!conversation) return;

            const messageToDelete = conversation.messages[index];
            let messagesToRemove = 1;

            if (messageToDelete.role === 'user' && index + 1 < conversation.messages.length && conversation.messages[index + 1].role === 'assistant') {
                messagesToRemove = 2;
            }

            showConfirmModal("Delete Message?", `Are you sure you want to delete this message${messagesToRemove > 1 ? ' and the AI\'s response' : ''}?`, (confirmed) => {
                if (confirmed) {
                    conversation.messages.splice(index, messagesToRemove);
                    saveStateToDB();
                    loadConversation(state.activeConversationId);
                }
            });
        }


        function typeWriter(element, text, i = 0) {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                setTimeout(() => typeWriter(element, text, i + 1), 90);
            }
        }

        function setupEventListeners() {
            dom.loginBtn.addEventListener('click', async () => {
                await puter.auth.signIn();
                handleAuthState();
            });
            dom.logoutBtn.addEventListener('click', async () => {
                await puter.auth.signOut();
                handleAuthState();
            });

            dom.sendBtn.addEventListener('click', () => {
                if (isThinking) {
                    if (abortController) {
                        abortController.abort("User cancelled request");
                    }
                } else {
                    handleSendMessage();
                }
            });

            dom.chatWindow.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link && link.href) {
                    e.preventDefault();
                    showLinkModal(link.href);
                }
            });

            dom.chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && window.innerWidth > 768) {
                    e.preventDefault();
                    if (!isThinking) handleSendMessage();
                }
            });
            dom.chatInput.addEventListener('input', () => { dom.chatInput.style.height = 'auto'; dom.chatInput.style.height = (dom.chatInput.scrollHeight) + 'px'; });

            const handleConversationAction = (e) => {
                const target = e.target;
                const convoItem = target.closest('.conversation-item');
                if (!convoItem) return;
                const convoId = convoItem.dataset.id;

                if (target.closest('.conversation-menu-btn')) {
                    e.stopPropagation();
                    const dropdown = convoItem.querySelector('.conversation-menu');
                    const isHidden = dropdown.classList.contains('hidden');
                    document.querySelectorAll('.conversation-menu').forEach(m => m.classList.add('hidden'));
                    if (isHidden) dropdown.classList.remove('hidden');
                    return;
                }
                if (target.closest('.rename-btn')) {
                    e.stopPropagation();
                    renameConversation(convoId);
                    target.closest('.conversation-menu').classList.add('hidden');
                    return;
                }
                if (target.closest('.delete-btn')) {
                    e.stopPropagation();
                    deleteConversation(convoId);
                    target.closest('.conversation-menu').classList.add('hidden');
                    return;
                }
                if (target.closest('.pin-btn')) {
                    e.stopPropagation();
                    togglePinConversation(convoId);
                    target.closest('.conversation-menu').classList.add('hidden');
                    return;
                }
                if (convoId) {
                    loadConversation(convoId);
                    if (window.innerWidth <= 768) {
                        toggleSidebar();
                    }
                }
            };

            dom.conversationList.addEventListener('click', handleConversationAction);

            dom.headerNewChatBtnDesktop.addEventListener('click', createNewConversation);
            dom.headerNewChatBtnMobile.addEventListener('click', createNewConversation);

            [dom.modelSelectorBtnDesktop, dom.modelSelectorBtnMobile].forEach(btn => btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = (window.innerWidth <= 768) ? dom.modelSelectorDropdownMobile : dom.modelSelectorDropdownDesktop;
                dropdown.classList.toggle('hidden');
            }));

            const toggleSidebar = () => {
                const isExpanded = dom.conversationsContainer.classList.toggle('expanded');
                if (window.innerWidth <= 768) {
                    dom.sidebarBackdrop.classList.toggle('hidden', !isExpanded);
                }
            };

            dom.sidebarMenuBtn.addEventListener('click', toggleSidebar);
            dom.headerMenuBtn.addEventListener('click', toggleSidebar);
            dom.sidebarBackdrop.addEventListener('click', toggleSidebar);

            if (window.innerWidth > 768) {
                dom.conversationsContainer.addEventListener('mouseenter', () => dom.conversationsContainer.classList.add('expanded'));
                dom.conversationsContainer.addEventListener('mouseleave', () => dom.conversationsContainer.classList.remove('expanded'));
            }

            dom.searchInput.addEventListener('input', (e) => filterConversations(e.target.value));
            dom.memoriesBtn.addEventListener('click', showMemoriesModal);
            dom.closeMemoriesBtn.addEventListener('click', () => dom.memoriesModal.classList.add('hidden'));
            dom.addMemoryBtn.addEventListener('click', () => editMemory(null));

            dom.editCharactersBtn.addEventListener('click', showCharacterModal);
            dom.closeCharacterBtn.addEventListener('click', () => dom.characterModal.classList.add('hidden'));
            dom.addCharacterBtn.addEventListener('click', () => editCharacter(null));

            dom.characterSwitcherBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dom.characterSwitcherDropdown.classList.toggle('hidden');
            });

            dom.characterSwitcherDropdown.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.model-selector-item');
                if (target) {
                    const charId = target.dataset.charId;
                    state.activeCharacterId = (charId === 'null') ? null : charId;
                    saveStateToDB();
                    renderCharacterSwitcher();
                    dom.characterSwitcherDropdown.classList.add('hidden');
                }
            });


            document.addEventListener('click', (e) => {
                if (!e.target.closest('.conversation-menu-btn') && !e.target.closest('.conversation-menu')) {
                     document.querySelectorAll('.conversation-menu').forEach(m => m.classList.add('hidden'));
                }
                if (!dom.modelSelectorBtnDesktop.contains(e.target) && !dom.modelSelectorDropdownDesktop.contains(e.target)) {
                    dom.modelSelectorDropdownDesktop.classList.add('hidden');
                }
                 if (!dom.modelSelectorBtnMobile.contains(e.target) && !dom.modelSelectorDropdownMobile.contains(e.target)) {
                    dom.modelSelectorDropdownMobile.classList.add('hidden');
                }
                if (!dom.characterSwitcherBtn.contains(e.target) && !dom.characterSwitcherDropdown.contains(e.target)) {
                    dom.characterSwitcherDropdown.classList.add('hidden');
                }
                if (!e.target.closest('.memory-menu-btn') && !e.target.closest('.memory-menu')) {
                    document.querySelectorAll('.memory-menu').forEach(m => m.classList.add('hidden'));
                }
            });

            dom.scrollToTopBtn.addEventListener('click', () => {
                dom.chatWindow.scrollTo({ top: 0, behavior: 'smooth' });
            });
            dom.scrollToBottomBtn.addEventListener('click', () => {
                dom.chatWindow.scrollTo({ top: dom.chatWindow.scrollHeight, behavior: 'smooth' });
            });
            
            // --- REVERTED SCROLLING LOGIC ---
            dom.scrollPrevBtn.addEventListener('click', () => {
                const messages = Array.from(dom.chatWindow.querySelectorAll('.items-end[data-message-index]'));
                const currentTop = dom.chatWindow.scrollTop;
                const prevMessage = messages.reverse().find(m => m.offsetTop < currentTop - 1); // -1 to find strictly previous
                if (prevMessage) {
                    prevMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    setTimeout(() => dom.chatWindow.scrollBy(0, -16), 500); // scroll 1rem up after smooth scroll
                } else {
                    dom.chatWindow.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
            dom.scrollNextBtn.addEventListener('click', () => {
                const messages = Array.from(dom.chatWindow.querySelectorAll('.items-end[data-message-index]'));
                const currentBottom = dom.chatWindow.scrollTop + dom.chatWindow.clientHeight;
                const nextMessage = messages.find(m => m.offsetTop + m.clientHeight > currentBottom + 1); // +1 to find strictly next
                if (nextMessage) {
                    nextMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                     setTimeout(() => dom.chatWindow.scrollBy(0, -16), 500); // scroll 1rem up after smooth scroll
                } else {
                     dom.chatWindow.scrollTo({ top: dom.chatWindow.scrollHeight, behavior: 'smooth' });
                }
            });

            dom.chatWindow.addEventListener('scroll', () => {
                const { scrollTop, scrollHeight, clientHeight } = dom.chatWindow;
                const atTop = scrollTop < 50;
                const atBottom = scrollHeight - clientHeight - scrollTop < 50;

                dom.scrollToTopBtn.disabled = atTop;
                dom.scrollPrevBtn.disabled = atTop;
                dom.scrollNextBtn.disabled = atBottom;
                dom.scrollToBottomBtn.disabled = atBottom;
            });

            dom.importChatBtn.addEventListener('click', () => dom.importFileInput.click());
            dom.importFileInput.addEventListener('change', importConversation);

            dom.exportChatsBtn.addEventListener('click', showExportModal);
            dom.closeExportBtn.addEventListener('click', () => dom.exportModal.classList.add('hidden'));
            dom.exportCancelBtn.addEventListener('click', () => dom.exportModal.classList.add('hidden'));
            dom.exportDownloadBtn.addEventListener('click', exportSelectedConversations);
        }

        function filterConversations(query) {
            const lowerCaseQuery = query.toLowerCase();
            const conversationItems = dom.conversationList.querySelectorAll('div[data-id]');
            conversationItems.forEach(item => {
                const title = item.querySelector('.sidebar-text').textContent.toLowerCase();
                item.style.display = title.includes(lowerCaseQuery) ? 'flex' : 'none';
            });
        }

        function setThinkingState(isThinkingNow) {
            isThinking = isThinkingNow;
            dom.chatInput.disabled = isThinkingNow;
            dom.modelSelectorBtnDesktop.disabled = isThinkingNow;
            dom.modelSelectorBtnMobile.disabled = isThinkingNow;

            document.querySelectorAll('.regenerate-btn, .delete-msg-btn').forEach(btn => {
                btn.disabled = isThinkingNow;
            });

            if (isThinkingNow) {
                dom.sendBtn.innerHTML = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><rect width="10" height="10" x="5" y="5" rx="1"></rect></svg>`;
            } else {
                dom.sendBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>`;
            }
        }

        async function handleSendMessage() {
            if (isThinking) return;

            const messageText = dom.chatInput.value.trim();
            if (!messageText) return;

            const conversation = state.conversations[state.activeConversationId];

            const userMessage = { role: 'user', content: messageText, timestamp: new Date().toISOString() };
            conversation.messages.push(userMessage);

            addMessageToChat(userMessage, conversation.messages.length - 1);

            if (conversation.title === 'New Chat' && messageText.length > 0) {
                conversation.title = messageText.substring(0, 25) + (messageText.length > 25 ? '...' : '');
                renderConversationList();
                updateUI();
            }

            dom.chatInput.value = '';
            dom.chatInput.style.height = 'auto';
            dom.chatInput.focus();

            await processAIResponse();
        }

        async function regenerateResponse(messageIndex) {
            if (isThinking) return;
            const conversation = state.conversations[state.activeConversationId];
            conversation.messages.splice(messageIndex);
            loadConversation(state.activeConversationId);
            await processAIResponse(messageIndex);
        }

        async function processAIResponse(regenerateIndex = -1) {
            setThinkingState(true);
            abortController = new AbortController();
            let wasAborted = false;

            const conversation = state.conversations[state.activeConversationId];

            const assistantPlaceholder = {
                role: 'assistant',
                content: '',
                modelUsed: 'thinking',
                timestamp: new Date().toISOString()
            };
            const thinkingMessageElement = addMessageToChat(assistantPlaceholder, conversation.messages.length);

            const startTime = performance.now();
            let fullResponseContent = "";
            let finalMessageObject = null;
            let responseContentElement = null;
            let finalMessageWrapper = null; 

            try {
                let messagesToSend = conversation.messages.slice(0)
                                                        .filter(msg => msg.modelUsed !== 'system' && msg.modelUsed !== 'thinking');

                const HISTORY_LIMIT = 5;
                let limitedHistory = messagesToSend.slice(-HISTORY_LIMIT);

                limitedHistory.unshift({ role: 'system', content: 'You MUST format responses using Markdown. Use lists, bolding, and code blocks where appropriate.' });

                if (state.activeCharacterId) {
                    const character = state.characters.find(c => c.id === state.activeCharacterId);
                    if (character) {
                        let persona = `You are to adopt the following persona. This is a role-playing instruction and you must adhere to it strictly for all subsequent responses.\n\n**Persona Description:**\n${character.description}`;
                        if(character.tags && character.tags.trim() !== "") {
                            persona += `\n\n**Key Traits/Tags:**\n${character.tags}`;
                        }
                        limitedHistory.unshift({ role: 'system', content: persona });
                    }
                }

                const lastUserMessage = messagesToSend.filter(m => m.role === 'user').pop();
                if (lastUserMessage && lastUserMessage.content.toLowerCase().includes('memory')) {
                     if (state.memories.length > 0) {
                         const memoryContext = "Here is some information I've saved as memories. Please use this to inform your responses when relevant:\n\n" +
                                               state.memories.map(m => `Title: ${m.title}\nContent: ${m.content}`).join('\n\n---\n\n');
                         limitedHistory.unshift({ role: 'system', content: memoryContext });
                     }
                }

                const responseStream = await puter.ai.chat(limitedHistory, {
                    model: state.currentModel,
                    signal: abortController.signal,
                    stream: true
                });

                let isFirstChunk = true;
                for await (const chunk of responseStream) {
                    const chunkContent = chunk.message?.content || chunk || '';
                    if (!chunkContent) continue;

                    if (isFirstChunk) {
                        isFirstChunk = false;
                        thinkingMessageElement.remove(); // Remove the "thinking..." bubble
                        
                        finalMessageObject = {
                            role: 'assistant',
                            content: '',
                            modelUsed: state.currentModel,
                            timestamp: new Date().toISOString()
                        };
                        conversation.messages.push(finalMessageObject);
                        finalMessageWrapper = addMessageToChat({ ...finalMessageObject, content: '' }, conversation.messages.length - 1);
                        responseContentElement = finalMessageWrapper.querySelector('.content-wrapper');
                    }

                    fullResponseContent += chunkContent;
                    if (responseContentElement) {
                        let htmlContent = marked.parse(fullResponseContent + '█');
                        responseContentElement.innerHTML = htmlContent;
                        dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
                    }
                }

            } catch (error) {
                if (error.name === 'AbortError' || error.message === "User cancelled request") {
                    console.log("Stream aborted by user.");
                    wasAborted = true;
                } else {
                    console.error('Puter.js Error:', error);
                    fullResponseContent = `**Error:** An unexpected error occurred. Please check the console for details. The selected model may not be available.`;
                }
            } finally {
                thinkingMessageElement?.remove();

                if (wasAborted) {
                    finalMessageWrapper?.remove();
                    if(finalMessageObject) conversation.messages.pop();
                } else if (finalMessageObject) {
                    finalMessageObject.content = fullResponseContent;
                    finalMessageObject.thinkingTime = (performance.now() - startTime) / 1000;
                    
                    // Re-render the final message from scratch to include thinking time and attach all listeners correctly
                    finalMessageWrapper?.remove();
                    addMessageToChat(finalMessageObject, conversation.messages.length - 1);
                } else {
                    if (fullResponseContent) {
                        const errorMsg = { role: 'assistant', content: fullResponseContent, modelUsed: 'system', timestamp: new Date().toISOString() };
                        conversation.messages.push(errorMsg);
                        addMessageToChat(errorMsg, conversation.messages.length - 1);
                    }
                }

                setThinkingState(false);
                saveStateToDB();
            }
        }

        function showMemoriesModal() { dom.memoriesModal.classList.remove('hidden'); renderMemoriesList(); }
        function renderMemoriesList() {
            dom.memoriesList.innerHTML = '';
            if (state.memories.length === 0) {
                dom.memoriesList.innerHTML = `<div class="text-center text-gray-500 p-8">No memories saved yet. Add one to get started!</div>`;
                return;
            }
            state.memories.forEach(memory => {
                const card = document.createElement('div');
                card.className = "memory-card group";
                card.dataset.id = memory.id;
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2 flex-shrink-0">
                        <h3 class="font-bold text-lg truncate">${memory.title}</h3>
                        <div class="relative z-10">
                            <button class="p-1 rounded-full hover:bg-black/20 memory-menu-btn">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                            </button>
                            <div class="absolute right-0 mt-2 w-32 bg-[var(--surface-dark)] border border-[var(--hover-dark)] rounded-md shadow-lg hidden z-20 memory-menu">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-[var(--hover-dark)] edit-btn">Edit</a>
                                <a href="#" class="block px-4 py-2 text-sm text-red-400 hover:bg-[var(--hover-dark)] delete-btn">Delete</a>
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-400 text-sm memory-card-content">${memory.content}</p>
                `;
                card.querySelector('.memory-menu-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const dropdown = card.querySelector('.memory-menu');
                    document.querySelectorAll('.memory-menu').forEach(m => { if (m !== dropdown) m.classList.add('hidden'); });
                    dropdown.classList.toggle('hidden');
                });
                card.querySelector('.edit-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); editMemory(memory.id); });
                card.querySelector('.delete-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); deleteMemory(memory.id); });
                dom.memoriesList.appendChild(card);
            });
        }

        function editMemory(id) {
            const isNew = id === null;
            const memory = isNew ? { title: '', content: '' } : state.memories.find(m => m.id === id);
            if (!memory) return;

            const modalTitle = isNew ? 'Add New Memory' : 'Edit Memory';

            dom.modalTitle.textContent = modalTitle;
            dom.modalContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Title</label>
                        <input id="modal-mem-title" type="text" value="${memory.title}" class="w-full bg-[var(--surface-light)] rounded-md py-2 px-3 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Content</label>
                        <textarea id="modal-mem-content" class="w-full h-40 bg-[var(--surface-light)] rounded-md py-2 px-3 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none resize-none">${memory.content}</textarea>
                    </div>
                </div>
            `;
            dom.modalActions.innerHTML = `<button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button><button id="modal-confirm" class="modern-btn font-bold py-2 px-4 rounded-md">Save</button>`;
            dom.genericModal.classList.remove('hidden');

            const titleInput = document.getElementById('modal-mem-title');
            const contentInput = document.getElementById('modal-mem-content');
            titleInput.focus();

            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            const cleanup = () => { dom.genericModal.classList.add('hidden'); };

            const submit = () => {
                const title = titleInput.value.trim();
                const content = contentInput.value.trim();
                if (!title || !content) return;

                if (isNew) {
                    state.memories.push({ id: `mem-${Date.now()}`, title, content });
                } else {
                    memory.title = title;
                    memory.content = content;
                }
                saveStateToDB();
                renderMemoriesList();
                cleanup();
            };

            confirmBtn.onclick = submit;
            cancelBtn.onclick = cleanup;
        }

        function deleteMemory(id) {
            showConfirmModal("Delete Memory?", "Are you sure you want to delete this memory?", (confirmed) => {
                if (confirmed) {
                    state.memories = state.memories.filter(m => m.id !== id);
                    saveStateToDB();
                    renderMemoriesList();
                }
            });
        }

        function togglePinConversation(convoId) {
            const index = state.pinnedConversations.indexOf(convoId);
            if (index > -1) {
                state.pinnedConversations.splice(index, 1);
            } else {
                state.pinnedConversations.push(convoId);
            }
            saveStateToDB();
            renderConversationList();
        }

        function showCharacterModal() {
            dom.characterModal.classList.remove('hidden');
            renderCharacterListInModal();
        }

        function renderCharacterListInModal() {
            dom.characterList.innerHTML = '';
            if (state.characters.length === 0) {
                dom.characterList.innerHTML = `<div class="text-center text-gray-500 p-8">No characters created yet.</div>`;
                return;
            }
            state.characters.forEach(char => {
                const card = document.createElement('div');
                card.className = `character-card`;
                card.dataset.id = char.id;
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg">${char.name}</h3>
                        <div class="flex items-center space-x-2 flex-shrink-0 ml-4">
                            <label class="flex items-center cursor-pointer">
                                <span class="mr-2 text-sm text-gray-400">Show</span>
                                <div class="relative">
                                    <input type="checkbox" class="sr-only visibility-toggle" ${char.isVisible ? 'checked' : ''}>
                                    <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                            </label>
                            <button title="Edit" class="p-2 rounded-full hover:bg-[var(--hover-dark)] edit-char-btn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                            </button>
                            <button title="Delete" class="p-2 rounded-full hover:bg-[var(--hover-dark)] text-red-400 delete-char-btn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                card.querySelector('.visibility-toggle').addEventListener('change', (e) => toggleCharacterVisibility(char.id, e.target.checked));
                card.querySelector('.edit-char-btn').addEventListener('click', () => editCharacter(char.id));
                card.querySelector('.delete-char-btn').addEventListener('click', () => deleteCharacter(char.id));
                dom.characterList.appendChild(card);
            });
            const style = document.createElement('style');
            style.innerHTML = `
                .visibility-toggle:checked ~ .dot { transform: translateX(100%); background-color: var(--primary-accent); }
                .visibility-toggle:checked ~ .block { background-color: var(--primary-accent-darker); }
            `;
            dom.characterList.appendChild(style);
        }

        function editCharacter(id) {
            const isNew = id === null;
            const character = isNew ? { name: '', description: '', tags: '' } : state.characters.find(c => c.id === id);
            if (!character) return;

            const modalTitle = isNew ? 'Add New Character' : 'Edit Character';

            dom.modalTitle.textContent = modalTitle;
            dom.modalContent.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Name</label>
                        <input id="modal-char-name" type="text" value="${character.name}" class="w-full bg-[var(--surface-light)] rounded-md py-2 px-3 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Description (Persona)</label>
                        <textarea id="modal-char-desc" class="w-full h-40 bg-[var(--surface-light)] rounded-md py-2 px-3 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none resize-none">${character.description}</textarea>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Tags (comma-separated)</label>
                        <input id="modal-char-tags" type="text" value="${character.tags || ''}" placeholder="e.g. ruthless, concise, witty" class="w-full bg-[var(--surface-light)] rounded-md py-2 px-3 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none">
                    </div>
                </div>
            `;
            dom.modalActions.innerHTML = `<button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button><button id="modal-confirm" class="modern-btn font-bold py-2 px-4 rounded-md">Save</button>`;
            dom.genericModal.classList.remove('hidden');

            const nameInput = document.getElementById('modal-char-name');
            const descInput = document.getElementById('modal-char-desc');
            const tagsInput = document.getElementById('modal-char-tags');
            nameInput.focus();

            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            const cleanup = () => { dom.genericModal.classList.add('hidden'); };

            const submit = () => {
                const name = nameInput.value.trim();
                const description = descInput.value.trim();
                const tags = tagsInput.value.trim();
                if (!name || !description) return;

                if (isNew) {
                    state.characters.push({ id: `char-${Date.now()}`, name, description, tags, isVisible: true });
                } else {
                    character.name = name;
                    character.description = description;
                    character.tags = tags;
                }
                saveStateToDB();
                renderCharacterListInModal();
                renderCharacterSwitcher();
                cleanup();
            };

            confirmBtn.onclick = submit;
            cancelBtn.onclick = cleanup;
        }

        function deleteCharacter(id) {
            showConfirmModal("Delete Character?", "Are you sure? This cannot be undone.", (confirmed) => {
                if (confirmed) {
                    state.characters = state.characters.filter(c => c.id !== id);
                    if (state.activeCharacterId === id) {
                        state.activeCharacterId = null;
                    }
                    saveStateToDB();
                    renderCharacterListInModal();
                    renderCharacterSwitcher();
                }
            });
        }

        function toggleCharacterVisibility(id, isVisible) {
            const character = state.characters.find(c => c.id === id);
            if (character) {
                character.isVisible = isVisible;
                saveStateToDB();
                renderCharacterSwitcher();
            }
        }

        function renderCharacterSwitcher() {
            const activeCharacter = state.characters.find(c => c.id === state.activeCharacterId);

            dom.characterSwitcherBtn.innerHTML = `
                <span class="text-gray-400 mr-2 text-sm">Persona:</span>
                <span class="font-bold truncate">${activeCharacter ? activeCharacter.name : 'Default'}</span>
                <svg class="w-4 h-4 ml-auto flex-shrink-0 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path></svg>
            `;

            const dropdown = dom.characterSwitcherDropdown;
            dropdown.innerHTML = '';

            const defaultItem = document.createElement('a');
            defaultItem.href = '#';
            defaultItem.className = 'model-selector-item flex items-center px-4 py-2 text-sm text-gray-300';
            defaultItem.dataset.charId = 'null';
            defaultItem.innerHTML = '<span>Default (No Persona)</span>';
            if (!state.activeCharacterId) {
                defaultItem.classList.add('selected');
            }
            dropdown.appendChild(defaultItem);

            const visibleChars = state.characters.filter(c => c.isVisible);
            if (visibleChars.length > 0) {
                const separator = document.createElement('hr');
                separator.className = 'border-t border-[var(--hover-dark)] my-1 mx-2';
                dropdown.appendChild(separator);
            }

            visibleChars.forEach(char => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'model-selector-item flex items-center px-4 py-2 text-sm text-gray-300';
                item.dataset.charId = char.id;
                item.innerHTML = `<span>${char.name}</span>`;
                if (state.activeCharacterId === char.id) {
                    item.classList.add('selected');
                }
                dropdown.appendChild(item);
            });
        }


        function showLinkModal(url) {
            dom.modalTitle.textContent = "Link Action";
            dom.modalContent.innerHTML = `<p class="text-gray-400 break-all">URL: ${url}</p>`;
            dom.modalActions.innerHTML = `
                <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                <button id="modal-copy" class="modern-btn font-bold py-2 px-4 rounded-md">Copy Link</button>
                <button id="modal-open" class="modern-btn font-bold py-2 px-4 rounded-md">Open Link</button>
            `;
            dom.genericModal.classList.remove('hidden');

            const openBtn = document.getElementById('modal-open');
            const copyBtn = document.getElementById('modal-copy');
            const cancelBtn = document.getElementById('modal-cancel');

            const cleanup = () => {
                openBtn.replaceWith(openBtn.cloneNode(true));
                copyBtn.replaceWith(copyBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                dom.genericModal.classList.add('hidden');
            };

            openBtn.onclick = () => {
                window.open(url, '_blank', 'noopener,noreferrer');
                cleanup();
            };

            copyBtn.onclick = () => {
                navigator.clipboard.writeText(url).then(() => {
                    copyBtn.textContent = "Copied!";
                    setTimeout(() => { cleanup(); }, 1000);
                });
            };

            cancelBtn.onclick = cleanup;
        }

        function showConfirmModal(title, content, callback, isAlert = false) {
            dom.modalTitle.textContent = title;
            dom.modalContent.innerHTML = `<p class="text-gray-400">${content}</p>`;
            if (isAlert) {
                dom.modalActions.innerHTML = `<button id="modal-confirm" class="modern-btn font-bold py-2 px-4 rounded-md">OK</button>`;
            } else {
                dom.modalActions.innerHTML = `<button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button><button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Confirm</button>`;
            }
            dom.genericModal.classList.remove('hidden');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            const cleanup = () => {
                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                if (cancelBtn) cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                dom.genericModal.classList.add('hidden');
            };
            confirmBtn.onclick = () => { cleanup(); callback(true); };
            if (cancelBtn) {
                cancelBtn.onclick = () => { cleanup(); callback(false); };
            }
        }
        function showPromptModal(title, defaultValue, callback) {
            dom.modalTitle.textContent = title;
            dom.modalContent.innerHTML = `<input id="modal-input" type="text" class="w-full bg-[var(--surface-light)] rounded-md py-2 px-3 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none">`;
            const input = document.getElementById('modal-input');
            input.value = defaultValue;
            dom.modalActions.innerHTML = `<button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button><button id="modal-confirm" class="modern-btn font-bold py-2 px-4 rounded-md">Save</button>`;
            dom.genericModal.classList.remove('hidden');
            input.focus(); input.select();
            const confirmBtn = document.getElementById('modal-confirm'), cancelBtn = document.getElementById('modal-cancel');
            const cleanup = () => { confirmBtn.replaceWith(confirmBtn.cloneNode(true)); cancelBtn.replaceWith(cancelBtn.cloneNode(true)); dom.genericModal.classList.add('hidden'); };
            const submit = () => { const value = input.value.trim(); if (value) { cleanup(); callback(value); } };
            confirmBtn.onclick = submit;
            input.onkeydown = (e) => { if (e.key === 'Enter') submit(); };
            cancelBtn.onclick = () => { cleanup(); callback(null); };
        }

        function populateModelSelector() {
            const dropdowns = [dom.modelSelectorDropdownDesktop, dom.modelSelectorDropdownMobile];
            dropdowns.forEach(dropdown => {
                dropdown.innerHTML = '';
                for (const category in models) {
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'px-4 py-2 text-xs font-bold text-gray-400 uppercase';
                    categoryHeader.textContent = category;
                    dropdown.appendChild(categoryHeader);

                    models[category].forEach(model => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'model-selector-item flex items-center px-4 py-2 text-sm text-gray-300';
                        if (model.id === state.currentModel) {
                            item.classList.add('selected');
                        }
                        item.dataset.modelId = model.id;
                        item.innerHTML = `<img src="${model.logo}" alt="${model.name} logo" class="w-5 h-5 mr-3 rounded-full object-cover"><span>${model.name}</span>`;
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            state.currentModel = model.id;

                            if(state.activeConversationId) {
                                state.conversations[state.activeConversationId].model = model.id;
                            }

                            updateUI();
                            saveStateToDB();
                            dropdowns.forEach(d => d.classList.add('hidden'));
                        });
                        dropdown.appendChild(item);
                    });
                }
            });
        }

        function showExportModal() {
            dom.exportList.innerHTML = '';
            const sortedConversations = Object.values(state.conversations).sort((a,b) => b.timestamp - a.timestamp);

            sortedConversations.forEach(convo => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-3 p-2 rounded-md hover:bg-[var(--hover-dark)] cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" data-convo-id="${convo.id}" class="h-4 w-4 rounded bg-[var(--surface-dark)] border-[var(--hover-dark)] text-[var(--primary-accent)] focus:ring-[var(--primary-accent)]">
                    <span class="truncate">${convo.title}</span>
                `;
                dom.exportList.appendChild(label);
            });
            dom.exportModal.classList.remove('hidden');
        }

        function exportSelectedConversations() {
            const selectedIds = Array.from(dom.exportList.querySelectorAll('input:checked')).map(input => input.dataset.convoId);
            if (selectedIds.length === 0) {
                showConfirmModal("Export Error", "Please select at least one conversation to export.", () => {}, true);
                return;
            }

            const conversationsToExport = selectedIds.map(id => state.conversations[id]).filter(Boolean);

            const exportData = {
                type: "AetherionChatExport",
                version: 1,
                timestamp: new Date().toISOString(),
                data: conversationsToExport
            };

            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aetherion_export_${Date.now()}.aether`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            dom.exportModal.classList.add('hidden');
        }

        function importConversation(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.type !== "AetherionChatExport" || !Array.isArray(data.data)) {
                        throw new Error("Invalid or corrupted Aetherion export file.");
                    }

                    let importedCount = 0;
                    let lastImportedId = null;

                    data.data.forEach((convo, index) => {
                        if (convo.id && convo.title && Array.isArray(convo.messages)) {
                            const newId = `convo-imported-${Date.now()}-${index}`;
                            state.conversations[newId] = {
                                ...convo,
                                id: newId,
                                timestamp: Date.now() + index
                            };
                            lastImportedId = newId;
                            importedCount++;
                        }
                    });

                    if (importedCount === 0) {
                        throw new Error("No valid conversations found in the file.");
                    }

                    saveStateToDB();
                    renderConversationList();
                    if (lastImportedId) {
                        loadConversation(lastImportedId);
                    }
                    showConfirmModal("Import Successful", `${importedCount} conversation(s) imported successfully!`, () => {}, true);

                } catch (error) {
                    console.error("Failed to import chat:", error);
                    showConfirmModal("Import Error", `Error importing file: ${error.message}`, () => {}, true);
                } finally {
                    dom.importFileInput.value = '';
                }
            };
            reader.readAsText(file);
        }

        init();
    });
    </script>
</body>
</html>
