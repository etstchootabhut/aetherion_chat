<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <!-- FIX: Ensured user-scalable=no to prevent zooming which can interfere with layout -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi-Model AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.puter.com/v2/"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
        .then(() => console.log('Service Worker Registered'));
    }
    </script>
    <style>
        :root {
            --background-dark: #0D0D0D;
            --surface-dark: #1A1A1A;
            --surface-light: #2C2C2C;
            --primary-accent: #C8A2C8;
            --text-light: #EAEAEA;
            --text-dark: #1a1a1a;
            --hover-dark: #3D3D3D;
        }
        
        /* FIX: Removed fixed height and overflow from html/body to allow the browser to handle viewport resizing correctly, especially with the mobile keyboard. */
        body {
            background-color: var(--background-dark);
            color: var(--text-light);
        }

        /* FIX: Added min-width: 0 to prevent flex item from overflowing its container */
        .chat-bubble { max-width: 85%; word-wrap: break-word; overflow-wrap: break-word; min-width: 0; }
        .chat-bubble pre { border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; }

        #search-input { margin-bottom: 10px; }
        #search-input-container .pl-10{
            padding-left: .9rem;
        }
        
        /* FIX: Added display: block and max-width: 100% to the table wrapper. This ensures it behaves correctly within the flexbox context of the chat bubble and can't grow wider than its parent, allowing overflow-x to work as intended. */
        .chat-bubble .table-wrapper {
            display: block;
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 0.5rem;
            border: 1px solid var(--hover-dark);
            margin-top: 1em;
        }
        .chat-bubble table { width: 100%; border-collapse: collapse; }
        .chat-bubble th, .chat-bubble td { border: 1px solid var(--hover-dark); padding: 8px; border-left: 0; border-right: 0; }
        .chat-bubble th { background-color: var(--surface-light); }
        .chat-bubble code { background-color: var(--surface-dark); padding: 0.2em 0.4em; border-radius: 3px; }
        .chat-bubble pre code { background-color: transparent; padding: 0; }
        
        .chat-bubble > *:not(:last-child) { margin-bottom: 0.75rem; }
        .chat-bubble ul, .chat-bubble ol { padding-left: 1.5rem; }
        .chat-bubble li { margin-bottom: 0.25rem; }
        .chat-bubble blockquote { border-left: 4px solid var(--primary-accent); padding-left: 1rem; margin-left: 0.25rem; color: #a0aec0; }

        .user-bubble { color: var(--text-light) !important; border: none; }
        .user-bubble pre { color: inherit; }

        #conversations-panel { min-width: 256px; }
        
        .sidebar-text, #search-input-container, #username {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            white-space: nowrap;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--surface-dark); }
        ::-webkit-scrollbar-thumb { background: var(--hover-dark); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-accent); }
        
        #chat-input::-webkit-scrollbar, #memory-content::-webkit-scrollbar, #modal-textarea::-webkit-scrollbar { width: 5px; }
        #chat-input::-webkit-scrollbar-thumb, #memory-content::-webkit-scrollbar-thumb, #modal-textarea::-webkit-scrollbar-thumb { background: var(--primary-accent); }

        .thinking-dots span { animation: blink 1.4s infinite both; }
        .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }

        #chat-input { max-height: 120px; }
        #chat-input:focus { outline: none; box-shadow: none; }

        #header-new-chat-btn-desktop, #header-new-chat-btn-mobile {
            transition: background-color 0.1s ease, transform 0.1s ease; height: 40px; background-color: #C8A2C8; color: black;
        }
        #header-new-chat-btn-desktop:active, #header-new-chat-btn-mobile:active {
            background-color: var(--primary-accent);
            color: var(--background-dark);
            transform: scale(0.95);
        }

        @media (min-width: 769px) {
            #conversations-container {
                width: 68px;
                transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                overflow-x: hidden;
                background-color: var(--surface-dark);
            }
            #conversations-container.expanded { width: 256px; }
            #conversations-container.expanded .sidebar-text,
            #conversations-container.expanded #search-input-container,
            #conversations-container.expanded #username {
                opacity: 1;
            }
            #conversations-container:not(.expanded) #conversation-list,
            #conversations-container:not(.expanded) #search-input-container {
                display: none;
            }
            #header-menu-btn { display: none; }
        }

        @media (max-width: 768px) {
            #sidebar-menu-btn { display: none; }
            #conversations-container {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 40;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                width: 256px !important;
                background-color: var(--surface-dark);
            }
            #conversations-container.expanded { transform: translateX(0); }
            #conversations-container.expanded .sidebar-text,
            #conversations-container.expanded #search-input-container,
            #conversations-container.expanded #username {
                opacity: 1;
            }
            #sidebar-backdrop {
                position: fixed;
                inset: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 30;
            }
            
            #memories-modal { padding: 0; }
            #memories-modal > .bg-\[var\(--surface-dark\)\] { width: 100%; height: 100%; max-width: 100%; max-height: 100%; border-radius: 0; }
            #memories-modal-header h2 { font-size: 1.25rem; }
            #memories-modal-header #add-memory-btn { padding: 0.25rem 0.75rem; font-size: 0.875rem; }
            
            #header-menu-btn, #main-header .absolute.right-4 { position: static; transform: none; background-color: #C8A2C8; color: #0D0D0D; }
            #main-header { gap: 0.5rem; }
            #main-header .flex-1.text-center { display: flex; flex-direction: column; align-items: center; min-width: 0; }
            #mobile-header-title-container { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
            
            main > footer { padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<!-- FIX: Removed flex, h-screen, and overflow-hidden from body. The main app container (#app) now controls the height. -->
<body class="font-sans">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50">
        <img src="https://placehold.co/80x80/C8A2C8/0D0D0D?text=AI" alt="Logo" class="w-20 h-20 rounded-full mb-6">
        <h1 class="text-3xl font-bold text-white mb-2">Welcome to Multi-Model AI Chat</h1>
        <p class="text-gray-400 mb-8">Please log in with your Puter account to continue.</p>
        <button id="login-btn" class="bg-[var(--primary-accent)] hover:opacity-80 text-black font-bold py-3 px-6 rounded-lg transition-all duration-300">
            Login with Puter
        </button>
    </div>

    <!-- Generic Modal for Prompts/Confirms -->
    <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[60] hidden">
        <div class="bg-[var(--surface-dark)] rounded-lg shadow-xl w-full max-w-md flex flex-col p-6">
            <h2 id="modal-title" class="text-xl font-bold mb-4"></h2>
            <div id="modal-content" class="mb-6"></div>
            <div id="modal-actions" class="flex justify-end space-x-2"></div>
        </div>
    </div>

    <!-- Memories Modal -->
    <div id="memories-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-[var(--surface-dark)] rounded-lg shadow-xl w-full max-w-4xl h-5/6 flex flex-col p-6">
            <div id="memories-modal-header" class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold">Chat Memories</h2>
                <div class="flex items-center space-x-2">
                    <button id="add-memory-btn" class="text-sm bg-[var(--primary-accent)] text-black font-bold py-2 px-4 rounded-md hover:opacity-90">Add New Memory</button>
                    <button id="close-memories-btn" class="p-2 rounded-full hover:bg-[var(--hover-dark)] text-2xl leading-none">&times;</button>
                </div>
            </div>
            <div id="memories-list" class="flex-grow overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <!-- Main App Container (Initially Hidden) -->
    <!-- FIX: Set height to h-screen here. This makes the app container fill the viewport, providing a stable context for the keyboard to appear over. -->
    <div id="app" class="flex w-full h-screen relative hidden">
        <div id="sidebar-backdrop" class="hidden"></div>
        <div id="conversations-container" class="h-full flex flex-col shadow-lg">
            <aside id="conversations-panel" class="h-full flex flex-col p-2 space-y-2">
                <div class="flex items-center space-x-2 h-12">
                     <button id="sidebar-menu-btn" title="Menu" class="p-3 rounded-md hover:bg-[var(--hover-dark)] flex-shrink-0">
                         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <span id="username" class="font-bold text-lg truncate sidebar-text"></span>
                </div>
                <div id="search-input-container" class="relative flex items-center">
                    <input id="search-input" type="text" placeholder="Search..." class="w-full bg-[var(--surface-light)] rounded-md py-2 pl-10 pr-4 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none">
                </div>
                <div class="flex-grow overflow-y-auto px-1">
                    <div id="conversation-list"></div>
                </div>
                <div class="mt-auto space-y-1">
                    <button id="memories-btn" title="Memories" class="w-full flex items-center text-gray-300 hover:bg-[var(--hover-dark)] p-3 rounded-md transition-all duration-300">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                        <span class="sidebar-text ml-2">Memories</span>
                    </button>
                    <button id="logout-btn" title="Logout" class="w-full flex items-center text-gray-300 hover:bg-[var(--hover-dark)] p-3 rounded-md transition-all duration-300">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        <span class="sidebar-text ml-2">Logout</span>
                    </button>
                </div>
            </aside>
        </div>

        <!-- FIX: Replaced min-h-0 with overflow-hidden. This creates a stable flex container where the chat window can grow/shrink without affecting the whole page. -->
        <main class="flex-1 flex flex-col bg-[var(--background-dark)] overflow-hidden">
            <header id="main-header" class="relative flex items-center justify-between p-4 border-b border-[var(--surface-dark)] flex-shrink-0">
                <button id="header-menu-btn" title="Menu" class="p-2 rounded-md hover:bg-[var(--hover-dark)] md:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                
                <div class="hidden md:flex flex-1 items-center justify-between">
                    <div class="flex items-baseline space-x-2 min-w-0">
                        <h2 class="text-2xl font-bold text-gray-300 flex-shrink-0"><span class="text-[var(--primary-accent)]">A</span>etherion</h2>
                        <span class="text-gray-500 text-xl">/</span>
                        <h1 id="chat-title-desktop" class="text-lg font-bold truncate text-gray-400">New Chat</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button id="model-selector-btn-desktop" class="flex items-center w-full text-left bg-[var(--surface-dark)] p-2 rounded-md hover:bg-[var(--hover-dark)]">
                                <img src="https://placehold.co/20x20/10A37F/FFFFFF?text=O" alt="GPT-4o Mini logo" class="w-5 h-5 mr-2 rounded-full flex-shrink-0">
                                <span class="truncate">GPT-4o Mini</span>
                                <svg class="w-4 h-4 ml-auto flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="model-selector-dropdown-desktop" class="absolute right-0 mt-2 w-72 bg-[var(--surface-light)] border border-[var(--hover-dark)] rounded-md shadow-lg hidden z-10"></div>
                        </div>
                        <button id="header-new-chat-btn-desktop" class="flex items-center space-x-2 bg-[var(--surface-dark)] px-4 py-2 rounded-md hover:bg-[var(--hover-dark)] text-sm font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span>New Chat</span>
                        </button>
                    </div>
                </div>

                <div class="flex-1 text-center md:hidden">
                    <div id="mobile-header-title-container" class="flex items-baseline justify-center space-x-2">
                        <h2 class="text-md font-bold text-gray-300"><span class="text-[var(--primary-accent)]">A</span>etherion</h2>
                        <span class="text-gray-500 text-sm">/</span>
                        <h1 id="chat-title-mobile" class="text-sm font-bold truncate text-gray-400">New Chat</h1>
                    </div>
                    <div class="relative inline-block mt-1">
                        <button id="model-selector-btn-mobile" class="flex items-center w-full text-left bg-[var(--surface-dark)] p-2 rounded-md hover:bg-[var(--hover-dark)] text-xs">
                            <img src="https://placehold.co/20x20/10A37F/FFFFFF?text=O" alt="GPT-4o Mini logo" class="w-5 h-5 mr-2 rounded-full flex-shrink-0">
                            <span class="truncate">GPT-4o Mini</span>
                            <svg class="w-4 h-4 ml-auto flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="model-selector-dropdown-mobile" class="absolute left-1/2 -translate-x-1/2 mt-2 w-72 bg-[var(--surface-light)] border border-[var(--hover-dark)] rounded-md shadow-lg hidden z-10"></div>
                    </div>
                </div>
                <div class="md:hidden">
                     <button id="header-new-chat-btn-mobile" title="New Chat" class="flex items-center justify-center bg-[var(--surface-dark)] w-10 h-10 rounded-md hover:bg-[var(--hover-dark)]">
                         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                    </button>
                </div>
            </header>

            <!-- This div will grow and shrink, and its content will scroll -->
            <div id="chat-window" class="flex-1 p-4 overflow-y-auto"></div>

            <!-- This footer will be pushed to the bottom by the chat-window above it -->
            <footer class="p-4 flex-shrink-0">
                <div class="flex items-end bg-[var(--surface-dark)] rounded-[25px] p-2">
                    <textarea id="chat-input" class="flex-1 bg-transparent p-2 text-white resize-none focus:ring-0 overflow-y-auto" placeholder="Type a message..." rows="1"></textarea>
                    <button id="send-btn" class="bg-[var(--primary-accent)] hover:opacity-80 text-black font-bold p-2 rounded-full ml-2 flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </div>
            </footer>
        </main>
    </div>

    <script>
        // The Javascript logic remains the same as it was already well-structured.
        // The fixes are primarily in the CSS and HTML structure to handle layout.
        document.addEventListener('DOMContentLoaded', () => {
            let state = {
                conversations: {},
                activeConversationId: null,
                currentModel: 'openrouter:openai/gpt-4o-mini',
                memories: [],
            };

            const models = {
                "Flash": [
                    { id: 'openrouter:openai/gpt-4o-mini', name: 'GPT-4o Mini', logo: 'https://i.pinimg.com/736x/67/a5/96/67a596df5a89ca51c948d0a4a8eea310.jpg' },
                    { id: 'openrouter:google/gemini-2.5-flash', name: 'Gemini 2.5 Flash', logo: 'https://i.pinimg.com/736x/08/d6/8d/08d68db04c1a718bec70a5eb79fe61bc.jpg' },
                    { id: 'openrouter:anthropic/claude-sonnet-4', name: 'Claude Sonnet', logo: 'https://i.pinimg.com/736x/1e/23/10/1e2310984ae6ceba64b0c21925a35813.jpg' },
                    { id: 'x-ai/grok-3-mini', name: 'Grok 3 mini', logo: 'https://i.pinimg.com/736x/9e/0f/38/9e0f389dac42629515b009524ed47ed7.jpg' },
                    { id: 'openrouter:openai/gpt-4o-mini-search-preview', name: 'GPT-4o Mini search', logo: 'https://i.pinimg.com/736x/67/a5/96/67a596df5a89ca51c948d0a4a8eea310.jpg' },
                ],
                "Deep Think": [
                    { id: 'gpt-5', name: 'GPT-5', logo: 'https://i.pinimg.com/736x/67/a5/96/67a596df5a89ca51c948d0a4a8eea310.jpg' },
                    { id: 'openrouter:anthropic/claude opus 4', name: 'Claude Opus 4', logo: 'https://i.pinimg.com/736x/1e/23/10/1e2310984ae6ceba64b0c21925a35813.jpg' },
                    { id: 'google/gemini-2.5-pro', name: 'Gemini 2.5 pro', logo: 'https://i.pinimg.com/736x/08/d6/8d/08d68db04c1a718bec70a5eb79fe61bc.jpg' },
                    { id: 'x-ai/grok-4', name: 'Grok 4', logo: 'https://i.pinimg.com/736x/9e/0f/38/9e0f389dac42629515b009524ed47ed7.jpg' },
                    { id: 'openrouter:deepseek/deepseek r1', name: 'Deepseek-r1', logo: 'https://www.iconpacks.net/icons/free-icons-7/free-icon-deepseek-black-white-square-symbol-logo-25664.png' },
                ]
            };

            const dom = {
                app: document.getElementById('app'),
                loginOverlay: document.getElementById('login-overlay'),
                loginBtn: document.getElementById('login-btn'),
                logoutBtn: document.getElementById('logout-btn'),
                chatWindow: document.getElementById('chat-window'),
                chatInput: document.getElementById('chat-input'),
                sendBtn: document.getElementById('send-btn'),
                conversationList: document.getElementById('conversation-list'),
                headerNewChatBtnDesktop: document.getElementById('header-new-chat-btn-desktop'),
                modelSelectorBtnDesktop: document.getElementById('model-selector-btn-desktop'),
                modelSelectorDropdownDesktop: document.getElementById('model-selector-dropdown-desktop'),
                chatTitleDesktop: document.getElementById('chat-title-desktop'),
                headerNewChatBtnMobile: document.getElementById('header-new-chat-btn-mobile'),
                modelSelectorBtnMobile: document.getElementById('model-selector-btn-mobile'),
                modelSelectorDropdownMobile: document.getElementById('model-selector-dropdown-mobile'),
                chatTitleMobile: document.getElementById('chat-title-mobile'),
                conversationsContainer: document.getElementById('conversations-container'),
                sidebarMenuBtn: document.getElementById('sidebar-menu-btn'),
                headerMenuBtn: document.getElementById('header-menu-btn'),
                username: document.getElementById('username'),
                searchInput: document.getElementById('search-input'),
                memoriesBtn: document.getElementById('memories-btn'),
                memoriesModal: document.getElementById('memories-modal'),
                closeMemoriesBtn: document.getElementById('close-memories-btn'),
                memoriesList: document.getElementById('memories-list'),
                addMemoryBtn: document.getElementById('add-memory-btn'),
                genericModal: document.getElementById('generic-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalContent: document.getElementById('modal-content'),
                modalActions: document.getElementById('modal-actions'),
                sidebarBackdrop: document.getElementById('sidebar-backdrop'),
            };

            let db;
            function initDB() {
                const request = indexedDB.open('AI_Chat_App_DB_PuterOnly', 1);
                request.onerror = (event) => console.error("Database error:", event.target.errorCode);
                request.onsuccess = (event) => {
                    db = event.target.result;
                    handleAuthState();
                };
                request.onupgradeneeded = (event) => {
                    let db = event.target.result;
                    if (!db.objectStoreNames.contains('appState')) {
                        db.createObjectStore('appState', { keyPath: 'id' });
                    }
                };
            }

            function init() {
                initDB();
                populateModelSelector();
                setupEventListeners();
            }

            async function handleAuthState() {
                const loggedIn = await puter.auth.isSignedIn();
                if (loggedIn) {
                    dom.loginOverlay.classList.add('hidden');
                    dom.app.classList.remove('hidden');
                    const user = await puter.auth.getUser();
                    dom.username.textContent = user.username || 'User';
                    loadStateFromDB();
                } else {
                    dom.loginOverlay.classList.remove('hidden');
                    dom.app.classList.add('hidden');
                }
            }

            function saveStateToDB() {
                if (!db) return;
                try {
                    const transaction = db.transaction(['appState'], 'readwrite');
                    const store = transaction.objectStore('appState');
                    const stateToSave = JSON.parse(JSON.stringify(state));
                    store.put({ id: 'main', ...stateToSave });
                } catch (error) { console.error("Failed to save state:", error); }
            }

            function loadStateFromDB() {
                if (!db) return;
                const transaction = db.transaction(['appState'], 'readonly');
                const store = transaction.objectStore('appState');
                const request = store.get('main');
                request.onsuccess = () => {
                    if (request.result) {
                        state = { ...state, ...request.result };
                        if (!state.memories) state.memories = [];
                    }
                    if (!state.activeConversationId || !state.conversations[state.activeConversationId]) {
                        createNewConversation();
                    } else {
                        loadConversation(state.activeConversationId);
                    }
                    renderConversationList();
                    updateUI();
                };
            }
            
            function getCurrentModel() {
                for (const category in models) {
                    const foundModel = models[category].find(m => m.id === state.currentModel);
                    if (foundModel) return foundModel;
                }
                return null;
            }
            
            function updateUI() {
                const currentModel = getCurrentModel();
                
                const modelName = currentModel ? currentModel.name : 'Select Model';
                const modelLogo = currentModel ? currentModel.logo : 'https://placehold.co/20x20/FFFFFF/000000?text=?';

                const modelDisplayHTML = `
                    <img src="${modelLogo}" alt="${modelName} logo" class="w-5 h-5 mr-2 rounded-full flex-shrink-0 object-cover">
                    <span class="truncate">${modelName}</span>
                    <svg class="w-4 h-4 ml-auto flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                `;
                
                dom.modelSelectorBtnDesktop.innerHTML = modelDisplayHTML;
                dom.modelSelectorBtnMobile.innerHTML = modelDisplayHTML;
                
                const activeConvo = state.conversations[state.activeConversationId];
                const chatTitle = activeConvo ? activeConvo.title : 'New Chat';
                dom.chatTitleDesktop.textContent = chatTitle;
                dom.chatTitleMobile.textContent = chatTitle;
            }

            function renderConversationList() {
                dom.conversationList.innerHTML = '';
                const sortedConversations = Object.values(state.conversations).sort((a,b) => b.timestamp - a.timestamp);
                
                if (sortedConversations.length === 0) return;

                sortedConversations.forEach(convo => {
                    const convoDiv = document.createElement('div');
                    convoDiv.className = `w-full flex items-center justify-between p-3 rounded-md cursor-pointer mb-1 group ${convo.id === state.activeConversationId ? 'bg-[var(--primary-accent)] text-black' : 'hover:bg-[var(--hover-dark)]'}`;
                    convoDiv.dataset.id = convo.id;
                    
                    const titleSpan = document.createElement('span');
                    titleSpan.className = "sidebar-text truncate";
                    titleSpan.textContent = convo.title;
                    
                    const menuBtn = document.createElement('button');
                    menuBtn.className = "conversation-menu-btn sidebar-text p-1 rounded-full hover:bg-black/20";
                    menuBtn.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>`;
                    
                    const menuDropdown = document.createElement('div');
                    menuDropdown.className = "absolute right-0 mt-2 w-32 bg-[var(--surface-light)] border border-[var(--hover-dark)] rounded-md shadow-lg hidden z-20 conversation-menu";
                    menuDropdown.innerHTML = `
                        <button class="block w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-[var(--hover-dark)] rename-btn">Rename</button>
                        <button class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-[var(--hover-dark)] delete-btn">Delete</button>
                    `;

                    convoDiv.appendChild(titleSpan);
                    const menuContainer = document.createElement('div');
                    menuContainer.className = "relative";
                    menuContainer.appendChild(menuBtn);
                    menuContainer.appendChild(menuDropdown);
                    convoDiv.appendChild(menuContainer);
                    
                    dom.conversationList.appendChild(convoDiv);
                });
            }

            function loadConversation(id) {
                state.activeConversationId = id;
                dom.chatWindow.innerHTML = '';
                const conversation = state.conversations[id];
                if (conversation) {
                    conversation.messages.forEach((msg, index) => addMessageToChat(msg, index));
                    state.currentModel = conversation.model || 'openrouter:openai/gpt-4o-mini';
                }
                updateUI();
                saveStateToDB();
                renderConversationList();
                dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
            }
            
            function createNewConversation() {
                const newId = `convo-${Date.now()}`;
                const initialMessage = { 
                    role: 'assistant', 
                    content: "Hello! I'm Aetherion, your AI assistant. How can I help you today?", 
                    modelUsed: 'system',
                    timestamp: new Date().toISOString() 
                };
                state.conversations[newId] = { id: newId, title: 'New Chat', messages: [initialMessage], model: state.currentModel, timestamp: Date.now() };
                state.activeConversationId = newId;
                loadConversation(newId);
                 if (window.innerWidth <= 768 && dom.conversationsContainer.classList.contains('expanded')) {
                     toggleSidebar();
                 }
            }

            function addMessageToChat({ role, content, modelUsed = null, thinkingTime = null, timestamp }, index) {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex flex-col mb-4 ${role === 'user' ? 'items-end' : 'items-start'}`;
                messageWrapper.dataset.messageIndex = index;
                
                if (role === 'assistant') {
                    let modelName = 'Aetherion';
                    if (modelUsed !== 'system') {
                        const modelInfo = models.Flash.find(m => m.id === modelUsed) || models["Deep Think"].find(m => m.id === modelUsed);
                        if (modelInfo) modelName = modelInfo.name;
                    }
                    const date = new Date(timestamp);
                    const displayTimestamp = !isNaN(date) ? date.toLocaleString() : 'Just now';
                    const nameplateDiv = document.createElement('div');
                    nameplateDiv.className = 'flex items-center space-x-2 text-xs text-black font-bold mb-2 px-3 py-1 bg-[var(--primary-accent)] rounded-full';
                    nameplateDiv.innerHTML = `
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        <span>${modelName} ${thinkingTime ? `(${thinkingTime.toFixed(2)}s)` : ''}</span>
                        <span class="text-gray-700 font-normal">${displayTimestamp}</span>
                    `;
                    messageWrapper.appendChild(nameplateDiv);
                }

                const contentDiv = document.createElement('div');
                const isUser = role === 'user';
                contentDiv.className = `chat-bubble p-3 rounded-lg ${isUser ? 'user-bubble bg-[var(--surface-light)]' : 'bg-[var(--surface-light)]'}`;
                
                const contentString = String(content);
                
                if (role === 'assistant') {
                    let htmlContent = marked.parse(contentString);
                    htmlContent = htmlContent.replace(/<table/g, '<div class="table-wrapper"><table').replace(/<\/table>/g, '</table></div>');
                    contentDiv.innerHTML = htmlContent;
                    contentDiv.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
                } else {
                    const pre = document.createElement('pre');
                    pre.textContent = contentString;
                    pre.style.whiteSpace = 'pre-wrap';
                    pre.style.fontFamily = 'inherit';
                    contentDiv.appendChild(pre);
                }
                
                messageWrapper.appendChild(contentDiv);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = `flex items-center space-x-2 mt-2 text-gray-400 ${isUser ? 'justify-end' : ''}`;
                
                const copyBtn = document.createElement('button');
                copyBtn.title = "Copy";
                copyBtn.className = "copy-btn hover:text-white";
                copyBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>`;
                copyBtn.addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    const originalIcon = button.innerHTML;
                    
                    const tempInput = document.createElement('textarea');
                    tempInput.value = content;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);

                    button.innerHTML = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    setTimeout(() => { button.innerHTML = originalIcon; }, 1500);
                });
                actionsDiv.appendChild(copyBtn);

                if (isUser) {
                    const conversation = state.conversations[state.activeConversationId];
                    if (index === conversation.messages.length - 1) { 
                        const editBtn = document.createElement('button');
                        editBtn.title = "Edit";
                        editBtn.className = "edit-btn hover:text-white";
                        editBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>`;
                        editBtn.addEventListener('click', () => {
                            dom.chatInput.value = content;
                            conversation.messages.splice(index, 1);
                            loadConversation(state.activeConversationId);
                            dom.chatInput.focus();
                        });
                        actionsDiv.appendChild(editBtn);
                    }
                } else { 
                     const regenerateBtn = document.createElement('button');
                     regenerateBtn.title = "Regenerate";
                     regenerateBtn.className = "regenerate-btn hover:text-white";
                     regenerateBtn.innerHTML = `<svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"></path><path d="M21 22v-6h-6"></path><path d="M21 12A9 9 0 0 0 6.44 4.54l-3.44 2.9"></path><path d="M3 12a9 9 0 0 0 14.56 7.46l3.44-2.9"></path></svg>`;
                     regenerateBtn.addEventListener('click', () => regenerateResponse(index));
                     actionsDiv.appendChild(regenerateBtn);
                }
                
                messageWrapper.appendChild(actionsDiv);
                dom.chatWindow.appendChild(messageWrapper);
                dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
            }
            
            function showThinkingIndicator() {
                const indicator = document.createElement('div');
                indicator.id = 'thinking-indicator';
                indicator.className = 'flex flex-col mb-4 items-start';
                indicator.innerHTML = `
                    <div class="flex items-center space-x-2 text-xs text-black font-bold mb-2 px-3 py-1 bg-[var(--primary-accent)] rounded-full">
                        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        <span>Aetherion is thinking</span>
                        <span class="thinking-dots"><span>.</span><span>.</span><span>.</span></span>
                    </div>
                `;
                dom.chatWindow.appendChild(indicator);
                dom.chatWindow.scrollTop = dom.chatWindow.scrollHeight;
            }

            function hideThinkingIndicator() {
                const indicator = document.getElementById('thinking-indicator');
                if (indicator) indicator.remove();
            }

            function setupEventListeners() {
                dom.loginBtn.addEventListener('click', async () => { await puter.auth.signIn(); handleAuthState(); });
                dom.logoutBtn.addEventListener('click', async () => { await puter.auth.signOut(); handleAuthState(); });
                dom.sendBtn.addEventListener('click', handleSendMessage);
                dom.chatInput.addEventListener('keydown', (e) => { 
                    if (e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault(); 
                        handleSendMessage(); 
                    } 
                });
                dom.chatInput.addEventListener('input', () => { dom.chatInput.style.height = 'auto'; dom.chatInput.style.height = (dom.chatInput.scrollHeight) + 'px'; });
                
                const handleConversationAction = (e) => {
                    const target = e.target;
                    const convoItem = target.closest('#conversation-list > div');
                    if (!convoItem) return;
                    const convoId = convoItem.dataset.id;

                    if (target.closest('.conversation-menu-btn')) {
                        e.stopPropagation();
                        const dropdown = convoItem.querySelector('.conversation-menu');
                        const isHidden = dropdown.classList.contains('hidden');
                        document.querySelectorAll('.conversation-menu').forEach(m => m.classList.add('hidden'));
                        if (isHidden) dropdown.classList.remove('hidden');
                        return;
                    }
                    if (target.closest('.rename-btn')) {
                        e.stopPropagation();
                        renameConversation(convoId);
                        target.closest('.conversation-menu').classList.add('hidden');
                        return;
                    }
                    if (target.closest('.delete-btn')) {
                        e.stopPropagation();
                        deleteConversation(convoId);
                        target.closest('.conversation-menu').classList.add('hidden');
                        return;
                    }
                    if (convoId) {
                        loadConversation(convoId);
                        if (window.innerWidth <= 768) {
                            toggleSidebar();
                        }
                    }
                };
                
                dom.conversationList.addEventListener('click', handleConversationAction);

                dom.headerNewChatBtnDesktop.addEventListener('click', createNewConversation);
                dom.headerNewChatBtnMobile.addEventListener('click', createNewConversation);

                [dom.modelSelectorBtnDesktop, dom.modelSelectorBtnMobile].forEach(btn => btn.addEventListener('click', (e) => { 
                    e.stopPropagation();
                    const dropdown = (window.innerWidth <= 768) ? dom.modelSelectorDropdownMobile : dom.modelSelectorDropdownDesktop;
                    dropdown.classList.toggle('hidden');
                }));
                
                const toggleSidebar = () => {
                    const isExpanded = dom.conversationsContainer.classList.toggle('expanded');
                    if (window.innerWidth <= 768) {
                        dom.sidebarBackdrop.classList.toggle('hidden', !isExpanded);
                    }
                };

                dom.sidebarMenuBtn.addEventListener('click', toggleSidebar);
                dom.headerMenuBtn.addEventListener('click', toggleSidebar);
                dom.sidebarBackdrop.addEventListener('click', toggleSidebar);

                if (window.innerWidth > 768) {
                    dom.conversationsContainer.addEventListener('mouseenter', () => dom.conversationsContainer.classList.add('expanded'));
                    dom.conversationsContainer.addEventListener('mouseleave', () => dom.conversationsContainer.classList.remove('expanded'));
                }
                
                dom.searchInput.addEventListener('input', (e) => filterConversations(e.target.value));
                
                dom.memoriesBtn.addEventListener('click', showMemoriesModal);
                dom.closeMemoriesBtn.addEventListener('click', () => dom.memoriesModal.classList.add('hidden'));
                dom.addMemoryBtn.addEventListener('click', addNewMemory);

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.conversation-menu-btn') && !e.target.closest('.conversation-menu')) {
                         document.querySelectorAll('.conversation-menu').forEach(m => m.classList.add('hidden'));
                    }
                    if (!dom.modelSelectorBtnDesktop.contains(e.target) && !dom.modelSelectorDropdownDesktop.contains(e.target)) {
                        dom.modelSelectorDropdownDesktop.classList.add('hidden');
                    }
                     if (!dom.modelSelectorBtnMobile.contains(e.target) && !dom.modelSelectorDropdownMobile.contains(e.target)) {
                        dom.modelSelectorDropdownMobile.classList.add('hidden');
                    }
                });
            }

            function filterConversations(query) {
                const lowerCaseQuery = query.toLowerCase();
                const conversationItems = dom.conversationList.querySelectorAll('div[data-id]');
                conversationItems.forEach(item => {
                    const title = item.querySelector('span').textContent.toLowerCase();
                    item.style.display = title.includes(lowerCaseQuery) ? 'flex' : 'none';
                });
            }

            function renameConversation(id) {
                const conversation = state.conversations[id];
                showPromptModal("Rename Conversation", conversation.title, (newTitle) => {
                    if (newTitle) {
                        conversation.title = newTitle;
                        saveStateToDB();
                        renderConversationList();
                        updateUI();
                    }
                });
            }

            function deleteConversation(id) {
                showConfirmModal("Delete Conversation?", "Are you sure? This action cannot be undone.", (confirmed) => {
                    if (confirmed) {
                        delete state.conversations[id];
                        if (state.activeConversationId === id) {
                            const remainingIds = Object.keys(state.conversations).sort((a, b) => state.conversations[b].timestamp - state.conversations[a].timestamp);
                            if (remainingIds.length > 0) {
                                loadConversation(remainingIds[0]);
                            } else {
                                createNewConversation();
                            }
                        }
                        saveStateToDB();
                        renderConversationList();
                    }
                });
            }

            async function handleSendMessage() {
                const messageText = dom.chatInput.value.trim();
                if (!messageText) return;

                const userMessage = { role: 'user', content: messageText, timestamp: new Date().toISOString() };
                const conversation = state.conversations[state.activeConversationId];
                
                let messagesToSend = [...conversation.messages, userMessage];

                if (state.memories.length > 0) {
                    const memoryContext = "Here is some information I've saved as memories. Please use this to inform your responses when relevant:\n\n" + 
                                          state.memories.map(m => `Title: ${m.title}\nContent: ${m.content}`).join('\n\n---\n\n');
                    messagesToSend.unshift({ role: 'system', content: memoryContext });
                }

                conversation.messages.push(userMessage);
                loadConversation(state.activeConversationId);
                
                if (conversation.title === 'New Chat' && messageText.length > 0) {
                    conversation.title = messageText.substring(0, 25) + (messageText.length > 25 ? '...' : '');
                }
                
                dom.chatInput.value = '';
                dom.chatInput.style.height = 'auto';
                renderConversationList();
                updateUI();
                
                showThinkingIndicator();
                const startTime = performance.now();

                try {
                    const response = await puter.ai.chat(messagesToSend, { model: state.currentModel });
                    const endTime = performance.now();
                    const thinkingTime = (endTime - startTime) / 1000;
                    const responseContent = response.message?.content || response;
                    const modelResponse = { 
                        role: 'assistant', 
                        content: responseContent, 
                        modelUsed: state.currentModel, 
                        thinkingTime,
                        timestamp: new Date().toISOString()
                    };
                    addMessageToChat(modelResponse, conversation.messages.length);
                    conversation.messages.push(modelResponse);
                } catch (error) {
                    console.error('Puter.js Error:', error);
                    let errorMessage = "An unexpected error occurred.";
                     try { 
                         const errorJson = JSON.parse(error.message);
                         if (errorJson.status === 401) errorMessage = "Authentication failed. Your Puter session may have expired. Please try logging out and back in.";
                         else if (errorJson.error?.delegate === 'usage-limited-chat') errorMessage = "Puter.js usage limit reached. Please check your account dashboard.";
                         else errorMessage = errorJson.error?.message || errorJson.message || 'An unknown error occurred.';
                     } catch (e) { errorMessage = error.message; }
                    const errorResponse = { 
                        role: 'assistant', 
                        content: `**Error:** ${errorMessage}`, 
                        modelUsed: 'system',
                        timestamp: new Date().toISOString()
                    };
                    addMessageToChat(errorResponse, conversation.messages.length);
                    conversation.messages.push(errorResponse);
                } finally {
                    hideThinkingIndicator();
                    saveStateToDB();
                }
            }

            async function regenerateResponse(messageIndex) {
                const conversation = state.conversations[state.activeConversationId];
                if (messageIndex === 0) return;

                const historyToRegen = conversation.messages.slice(0, messageIndex);
                
                const originalMessages = [...conversation.messages];
                conversation.messages.splice(messageIndex);
                loadConversation(state.activeConversationId);
                showThinkingIndicator();
                
                const startTime = performance.now();

                try {
                    const response = await puter.ai.chat(historyToRegen, { model: state.currentModel });
                    const endTime = performance.now();
                    const thinkingTime = (endTime - startTime) / 1000;
                    const responseContent = response.message?.content || response;
                    const newModelResponse = { 
                        role: 'assistant', 
                        content: responseContent, 
                        modelUsed: state.currentModel, 
                        thinkingTime,
                        timestamp: new Date().toISOString()
                    };
                    
                    state.conversations[state.activeConversationId].messages = originalMessages;
                    conversation.messages[messageIndex] = newModelResponse;
                    
                } catch (error) {
                    console.error('Puter.js Error on Regenerate:', error);
                    const errorResponse = { 
                        role: 'assistant', 
                        content: '**Error during regeneration.**', 
                        modelUsed: 'system',
                        timestamp: new Date().toISOString()
                    };
                    conversation.messages[messageIndex] = errorResponse;
                } finally {
                    hideThinkingIndicator();
                    loadConversation(state.activeConversationId);
                    saveStateToDB();
                }
            }

            function showMemoriesModal() {
                dom.memoriesModal.classList.remove('hidden');
                renderMemoriesList();
            }

            function renderMemoriesList() {
                dom.memoriesList.innerHTML = '';
                if (state.memories.length === 0) {
                    dom.memoriesList.innerHTML = `<div class="text-center text-gray-500 p-8">No memories saved yet. Add one to get started!</div>`;
                    return;
                }
                state.memories.forEach(memory => {
                    const card = document.createElement('div');
                    card.className = "bg-[var(--surface-light)] p-4 rounded-lg group";
                    card.dataset.id = memory.id;

                    const header = document.createElement('div');
                    header.className = "flex justify-between items-center mb-2";
                    
                    const title = document.createElement('h3');
                    title.className = "font-bold text-lg";
                    title.textContent = memory.title;

                    const menuContainer = document.createElement('div');
                    menuContainer.className = "relative";
                    const menuBtn = document.createElement('button');
                    menuBtn.className = "p-1 rounded-full hover:bg-black/20 memory-menu-btn";
                    menuBtn.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>`;
                    
                    const menuDropdown = document.createElement('div');
                    menuDropdown.className = "absolute right-0 mt-2 w-32 bg-[var(--surface-dark)] border border-[var(--hover-dark)] rounded-md shadow-lg hidden z-20 memory-menu";
                    menuDropdown.innerHTML = `
                        <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-[var(--hover-dark)] edit-btn">Edit</a>
                        <a href="#" class="block px-4 py-2 text-sm text-red-400 hover:bg-[var(--hover-dark)] delete-btn">Delete</a>
                    `;

                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.memory-menu').forEach(m => {
                            if (m !== menuDropdown) m.classList.add('hidden');
                        });
                        menuDropdown.classList.toggle('hidden');
                    });

                    menuDropdown.querySelector('.edit-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); editMemory(memory.id); menuDropdown.classList.add('hidden'); });
                    menuDropdown.querySelector('.delete-btn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); deleteMemory(memory.id); menuDropdown.classList.add('hidden'); });
                    
                    menuContainer.appendChild(menuBtn);
                    menuContainer.appendChild(menuDropdown);
                    header.appendChild(title);
                    header.appendChild(menuContainer);
                    
                    const content = document.createElement('p');
                    content.className = "text-gray-400 text-sm";
                    content.textContent = memory.content;

                    card.appendChild(header);
                    card.appendChild(content);
                    dom.memoriesList.appendChild(card);
                });
            }

            function addNewMemory() {
                showPromptModal("New Memory Title", "", (title) => {
                    if (title) {
                        showTextareaPromptModal("New Memory Content", "", (content) => {
                            if (content) {
                                const newMemory = { id: `mem-${Date.now()}`, title, content };
                                state.memories.push(newMemory);
                                saveStateToDB();
                                renderMemoriesList();
                            }
                        });
                    }
                });
            }

            function editMemory(id) {
                const memory = state.memories.find(m => m.id === id);
                if (!memory) return;
                showPromptModal("Edit Memory Title", memory.title, (newTitle) => {
                    if (newTitle) {
                         showTextareaPromptModal("Edit Memory Content", memory.content, (newContent) => {
                            if (newContent) {
                                memory.title = newTitle;
                                memory.content = newContent;
                                saveStateToDB();
                                renderMemoriesList();
                            }
                        });
                    }
                });
            }

            function deleteMemory(id) {
                showConfirmModal("Delete Memory?", "Are you sure you want to delete this memory?", (confirmed) => {
                    if (confirmed) {
                        state.memories = state.memories.filter(m => m.id !== id);
                        saveStateToDB();
                        renderMemoriesList();
                    }
                });
            }

            function showConfirmModal(title, content, callback) {
                dom.modalTitle.textContent = title;
                dom.modalContent.innerHTML = `<p class="text-gray-400">${content}</p>`;
                dom.modalActions.innerHTML = `
                    <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Confirm</button>
                `;
                dom.genericModal.classList.remove('hidden');

                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                const cleanup = () => {
                    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                    dom.genericModal.classList.add('hidden');
                };

                confirmBtn.onclick = () => { cleanup(); callback(true); };
                cancelBtn.onclick = () => { cleanup(); callback(false); };
            }

            function showPromptModal(title, defaultValue, callback) {
                dom.modalTitle.textContent = title;
                dom.modalContent.innerHTML = `<input id="modal-input" type="text" class="w-full bg-[var(--surface-light)] rounded-md py-2 px-3 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none">`;
                const input = document.getElementById('modal-input');
                input.value = defaultValue;
                
                dom.modalActions.innerHTML = `
                    <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button id="modal-confirm" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Save</button>
                `;
                dom.genericModal.classList.remove('hidden');
                input.focus();
                input.select();

                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                const cleanup = () => {
                    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                    dom.genericModal.classList.add('hidden');
                };

                const submit = () => {
                    const value = input.value.trim();
                    if (value) {
                        cleanup();
                        callback(value);
                    }
                };

                confirmBtn.onclick = submit;
                input.onkeydown = (e) => { if (e.key === 'Enter') submit(); };
                cancelBtn.onclick = () => { cleanup(); callback(null); };
            }
            
            function showTextareaPromptModal(title, defaultValue, callback) {
                dom.modalTitle.textContent = title;
                dom.modalContent.innerHTML = `<textarea id="modal-textarea" class="w-full h-48 bg-[var(--surface-light)] rounded-md py-2 px-3 focus:ring-1 focus:ring-[var(--primary-accent)] focus:outline-none resize-none"></textarea>`;
                const textarea = document.getElementById('modal-textarea');
                textarea.value = defaultValue;
                
                dom.modalActions.innerHTML = `
                    <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>
                    <button id="modal-confirm" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md">Save</button>
                `;
                dom.genericModal.classList.remove('hidden');
                textarea.focus();
                textarea.select();

                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');

                const cleanup = () => {
                    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                    cancelBtn.replaceWith(cancelBtn.cloneNode(true));
                    dom.genericModal.classList.add('hidden');
                };

                const submit = () => {
                    const value = textarea.value.trim();
                    cleanup();
                    callback(value);
                };

                confirmBtn.onclick = submit;
                cancelBtn.onclick = () => { cleanup(); callback(null); };
            }

            function populateModelSelector() {
                const dropdowns = [dom.modelSelectorDropdownDesktop, dom.modelSelectorDropdownMobile];
                dropdowns.forEach(dropdown => {
                    dropdown.innerHTML = '';
                    for (const category in models) {
                        const categoryHeader = document.createElement('div');
                        categoryHeader.className = 'px-4 py-2 text-xs font-bold text-gray-400 uppercase';
                        categoryHeader.textContent = category;
                        dropdown.appendChild(categoryHeader);

                        models[category].forEach(model => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'flex items-center px-4 py-2 text-sm text-gray-300 hover:bg-[var(--hover-dark)]';
                            item.dataset.modelId = model.id;
                            item.innerHTML = `<img src="${model.logo}" alt="${model.name} logo" class="w-5 h-5 mr-3 rounded-full object-cover"><span>${model.name}</span>`;
                            item.addEventListener('click', (e) => {
                                e.preventDefault();
                                state.currentModel = model.id;
                                if(state.activeConversationId) {
                                    state.conversations[state.activeConversationId].model = model.id;
                                }
                                updateUI();
                                saveStateToDB();
                                dropdowns.forEach(d => d.classList.add('hidden'));
                            });
                            dropdown.appendChild(item);
                        });
                    }
                });
            }

            init();
        });
    </script>
</body>
</html>
